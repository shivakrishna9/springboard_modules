<?php
/**
 * @file
 * Provides an upsell modal for creating recurring donations.
 */

/**
 * Implements hook_menu().
 */
function fundraiser_upsell_menu() {
  $items = array();
  $items['admin/springboard/settings/fundraiser/fundraiser_upsell'] = array(
    'title' => 'Fundraiser sustainer upsell settings',
    'description' => 'Administer fundraiser upsell settings.',
    'access arguments' => array('administer fundraiser upsells'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fundraiser_upsell_admin_settings_form'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/fundraiser_upsell.admin.inc',
  );
  $items['admin/springboard/settings/fundraiser/fundraiser_upsell/general'] = array(
    'title' => 'General settings',
    'description' => 'Administer fundraiser upsell settings.',
    'access arguments' => array('administer fundraiser upsells'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fundraiser_upsell_admin_settings_form'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'file' => 'includes/fundraiser_upsell.admin.inc',
  );
  $items['admin/springboard/settings/fundraiser/fundraiser_upsell/thank-you'] = array(
    'title' => 'Thank you settings',
    'description' => 'Administer fundraiser upsell "thank you" settings.',
    'access arguments' => array('administer fundraiser upsells'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fundraiser_upsell_admin_thank_you_settings'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/fundraiser_upsell.mail.inc',
  );
  // Give admins an easy way to preview the upsell & thank you content.
  $items['node/%node/upsell'] = array(
    'title' => 'Upsell preview',
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'fundraiser_upsell_content_preview',
    'page arguments' => array(1),
    'access callback' => 'fundraiser_upsell_preview_access',
    'access arguments' => array(1),
  );
  // Callback to process the POSTed modal upsell form.
  $items['node/%node/upsell/process'] = array(
    'title' => 'Process upsell form',
    'description' => 'Ajax callback to process the fundraiser upsell donation form',
    'type' => MENU_CALLBACK,
    'page callback' => 'fundraiser_upsell_ajax_process',
    'page arguments' => array(),
    'access callback' => 'fundraiser_upsell_access',
    'access arguments' => array(1),
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function fundraiser_upsell_permission() {
  return array(
    'administer fundraiser upsells' => array(
      'title' => t('Administer fundraiser upsell feature'),
      'description' => t('Perform administration tasks for fundraiser upsell.'),
    ),
  );
}

/**
 * Implements hook_form_alter().
 *
 * Inject the upsell settings form into donation edit forms and modify the
 * donation forms to process the upsell if necessary.
 */
function fundraiser_upsell_form_alter(&$form, &$form_state, $form_id) {
  // Edit form - inject the Upsell settings into the node form.
  if (!empty($form['#node_edit_form']) && fundraiser_upsell_is_available($form['#node'])) {
    fundraiser_upsell_add_node_settings($form);
  }
  // View form - add the upsell submit function unless blocked by cookies.
  elseif (!empty($form['#node'])
    && fundraiser_upsell_is_enabled($form['#node'])
    && fundraiser_upsell_should_display_modal()) {
    $form['#submit'][] = 'fundraiser_upsell_webform_submit';
  }
}

/**
 * Form for injecting into the node edit page.
 *
 * @param array $form
 *   The form to modify.
 */
function fundraiser_upsell_add_node_settings(&$form) {
  $node = $form['#node'];
  $form['fundraiser_upsell'] = array(
    '#type' => 'fieldset',
    '#title' => t('Upsell settings'),
    '#weight' => -4,
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'additional_settings',
    '#tree' => TRUE,
  );
  $form['fundraiser_upsell']['enabled'] = array(
    '#type' => 'checkbox',
    '#title' => t('Upsell enabled'),
    '#default_value' => !empty($node->upsell['enabled']) ? $node->upsell['enabled'] : '',
  );
  $form['fundraiser_upsell']['content'] = array(
    '#title' => t('Form specific Upsell Content'),
    '#type' => 'textarea',
    '#default_value' => !empty($node->upsell['content']) ? $node->upsell['content'] : '',
    '#description' => t('If no content is given the default will be used.'),
  );

  $form['fundraiser_upsell']['footer'] = array(
    '#title' => t('Form specific Upsell Footer'),
    '#type' => 'textarea',
    '#default_value' => !empty($node->upsell['footer']) ? $node->upsell['footer'] : '',
    '#description' => t('Content that goes below the upsell form.  It can be used for a disclaimer.'),
  );

  $form['fundraiser_upsell']['thankyou'] = array(
    '#title' => t('Thank you content'),
    '#type' => 'textarea',
    '#default_value' => !empty($node->upsell['thankyou']) ? $node->upsell['thankyou'] : '',
    '#description' => t('The content in the modal after the sustainer is processed.'),
  );

  $form['fundraiser_upsell']['modal_theme'] = array(
    '#type' => 'fieldset',
    '#title' => t('Modal theming'),
    '#weight' => 5,
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );
  $form['fundraiser_upsell']['modal_theme']['class'] = array(
    '#title' => t('CSS class(es)'),
    '#type' => 'textfield',
    '#default_value' => !empty($node->upsell['class']) ? $node->upsell['class'] : '',
    '#description' => t('Separate multiple classes with a space.'),
  );
  $form['fundraiser_upsell']['modal_theme']['width'] = array(
    '#title' => t('Modal window width (in pixels)'),
    '#type' => 'textfield',
    '#size' => 5,
    '#default_value' => !empty($node->upsell['modal_width']) ? $node->upsell['modal_width'] : 400,
    '#description' => t('This will override the site default.'),
  );
  $form['fundraiser_upsell']['modal_theme']['height'] = array(
    '#title' => t('Modal window height (in pixels)'),
    '#type' => 'textfield',
    '#size' => 5,
    '#default_value' => !empty($node->upsell['modal_height']) ? $node->upsell['modal_height'] : 300,
    '#description' => t('This will override the site default.'),
  );

  if (module_exists('market_source')) {
    $salesforce_campaign_options = market_source_get_campaigns();

    if (!empty($salesforce_campaign_options)) {
      $salesforce_campaign_options = array_merge(
        array('' => '(blank)'),
        $salesforce_campaign_options
      );

      $form['fundraiser_upsell']['additional_options'] = array(
        '#type' => 'fieldset',
        '#title' => t('Additional options'),
        '#weight' => 10,
        '#collapsible' => TRUE,
        '#collapsed' => TRUE,
      );

      $form['fundraiser_upsell']['additional_options']['upsell_campaign_id'] = array(
        '#title' => t('Sustainer Salesforce Campaign ID'),
        '#type' => 'select',
        '#options' => $salesforce_campaign_options,
        '#default_value' => !empty($node->upsell['campaign_id']) ? $node->upsell['campaign_id'] : variable_get('fundraiser_upsell_sf_campaign_id', ''),
        '#description' => t('Set the campaign id to be used for the upsell form. Please note that if this field is left blank, then all recurring donations will have blank campaign ids.'),
      );
    }
  }

  $form['#validate'][] = 'fundraiser_upsell_node_form_validate';
  $form['#submit'][] = 'fundraiser_upsell_node_form_submit';
}

/**
 * Additional validation for the fundraiser_upsell node settings.
 */
function fundraiser_upsell_node_form_validate($form, &$form_state) {
  $modal_width = $form_state['values']['fundraiser_upsell']['modal_theme']['width'];
  $modal_height = $form_state['values']['fundraiser_upsell']['modal_theme']['height'];
  if (empty($modal_width) || !is_numeric($modal_width)) {
    form_set_error('fundraiser_upsell][modal_theming][upsell_modal_width',
      t('The fundraiser upsell modal width must be a number.'));
  }
  if (empty($modal_height) || !is_numeric($modal_height)) {
    form_set_error('fundraiser_upsell][modal_theming][upsell_modal_height',
      t('The fundraiser upsell modal height must be a number.'));
  }
}

/**
 * Additional submit handler to move the upsell settings into an array.
 *
 * The node will then be saved with this data in $node->upsell.
 * Example: $node->upsell['enabled']
 */
function fundraiser_upsell_node_form_submit($form, &$form_state) {

}

/**
 * Extra donation form submit function to attach the upsell process.
 */
function fundraiser_upsell_webform_submit($form, &$form_state) {
  // If it's not successful (no submission ID), don't show upsell and skip
  // checking for the recurring setting.
  if (empty($form_state['values']['details']['sid'])) {
    return;
  }

  // Don't show upsell if the donor is already recurring.
  $recurring = FALSE;

  // First get the component ID of the recurring component.
  $recurring_cid = fundraiser_sustainers_get_recurring_cid_by_node($form['#node']);

  // Then determine if that component value is recurring.
  // !== because a cid could be 0.
  if ($recurring_cid !== FALSE) {
    $recurring_value = $form_state['values']['submitted'][$recurring_cid];
    $recurring = fundraiser_sustainers_component_value_is_recurring($recurring_value);
  }

  if (!$recurring) {
    // Add the upsell nid, sid, & uid to the session data so the modal can
    // be added to the page later in another hook.
    $_SESSION['upsell'] = array(
      'nid' => $form_state['values']['details']['nid'],
      'sid' => $form_state['values']['details']['sid'],
      'uid' => $form_state['values']['details']['uid'],
    );
  }
}

/**
 * Implements hook_page_alter().
 *
 * Adds the modal to the page.
 */
function fundraiser_upsell_page_alter(&$page) {
  // Check for upsell trigger.
  // Added by upsell's webform submit handler.
  if (!empty($_SESSION['upsell'])) {
    // Add the upsell to the page.
    $node = node_load($_SESSION['upsell']['nid']);

    $modal = array(
      '#theme' => 'fundraiser_upsell_modal',
      '#sid' => $_SESSION['upsell']['sid'],
      '#rejection_days' => variable_get('fundraiser_upsell_rejection_lifetime', '180'),
      '#footer' => variable_get('fundraiser_upsell_default_content_disclaimer', ''),
      '#preview' => FALSE,
    );

    // Override defaults.
    if (!empty($node->upsell['modal_theme']['width'])) {
      $modal['#width'] = $node->upsell['modal_theme']['width'];
    }
    if (!empty($node->upsell['modal_theme']['height'])) {
      $modal['#height'] = $node->upsell['modal_theme']['height'];
    }
    if (!empty($node->upsell['modal_theme']['class'])) {
      $modal['#class'] = $node->upsell['modal_theme']['class'];
    }
    if (!empty($node->upsell['content'])) {
      $modal['#content'] = $node->upsell['content'];
    }
    else {
      $modal['#content'] = variable_get('fundraiser_upsell_default_content', '');
    }

    // Add the modal to the bottom of the page.
    $page['footer']['message-modal'] = $modal;

    // Remove the upsell session data.
    $_SESSION['upsell'] = NULL;
  }
}

/**
 * Upsell donation form for the modal.
 *
 * @param int $sid
 *   Submission ID
 *
 * @return array
 *   Form API array.
 */
function fundraiser_upsell_donation_form($form, &$form_state, $sid = 0) {
  // Get the default suggested amount based on submitted order.
  $order = fundraiser_upsell_get_order_by_sid($sid);

  if (!empty($sid) && !empty($order) && is_object($order)) {
    $order_total = round($order->commerce_order_total['und'][0]['amount'] / 100);
    $suggested_amount = fundraiser_upsell_find_suggested_amount($order_total);
  }
  // Set default values.
  $suggested_amount = !empty($suggested_amount) ? $suggested_amount : 10;
  $order_id = !empty($order->order_id) ? $order->order_id : 0;
  $campaign_id = !empty($order->upsell['campaign_id']) ? $order->upsell['campaign_id'] : variable_get('fundraiser_upsell_sf_campaign_id', '');
  $nid = !empty($order->upsell['nid']) ? $order->upsell['nid'] : arg(1);
  // Build the form.
  $form = array();
  $form['amount'] = array(
    '#title' => t('Monthly donation'),
    '#type' => 'textfield',
    '#size' => 5,
    '#field_prefix' => '$',
    '#default_value' => $suggested_amount,
    '#weight' => -10,
  );
  $form['order_id'] = array(
    '#type' => 'hidden',
    '#value' => $order_id,
  );
  $form['campaign_id'] = array(
    '#type' => 'hidden',
    '#value' => $campaign_id,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Yes, Sign Me Up!'),
    '#attributes' => array('id' => 'edit-submit'),
  );
  $form['close'] = array(
    '#type' => 'button',
    '#value' => t('No Thanks'),
    '#weight' => 1,
    '#attributes' => array('id' => 'edit-close'),
  );

  $form['#action'] = url('node/' . $nid . '/upsell/process');
  return $form;
}

/**
 * Submission callback function for the modal upsell form.
 *
 * Does some error checking, clones the original order, uses the cloned order
 * to create a sustainer series, sets acceptance cookie, sends thankyou email,
 * and returns the content for the thankyou modal.
 *
 * @param array $data
 *   The submitted upsell form data.
 *
 * @return string
 *   Thank you content.
 */
function fundraiser_upsell_upsell_ajax_submit($data) {
  // Set the default values.
  global $user;
  $amount = $data['amount'];
  $campaign_id = $data['campaign_id'];
  $order = commerce_order_load($data['order_id']);
  $is_recurring = fundraiser_upsell_check_recurring($order->order_id);
  $different_user = ($user->uid != $order->uid) ? TRUE : FALSE;
  // If the donation is already recurring, then stop.
  if ($is_recurring) {
    watchdog('fundraiser_upsell', 'Upsell failed - order %oid is already recurring.', array('%oid' => $order->order_id), WATCHDOG_NOTICE);
    return 'This is already a recurring donation. Thank you.';
  }
  // If the user is different then stop - skip anon users because we don't know.
  if ($different_user && $user->uid != 0) {
    watchdog('fundraiser_upsell', 'Upsell user doesn\'t match the order %oid user.', array('%oid' => $order->order_id), WATCHDOG_NOTICE);
    return 'There was a problem processing your order. Please try again.';
  }

  // Decouple by cloning the order and creating recurring orders
  // from the new order.
  // This part isn't creating the donation object.
  $master_order = fundraiser_upsell_clone_order($order, array(
    'amount' => $amount,
    'status' => 'pending_future_payment',
  ));

  // Create the recurring donation series.
  $success = fundraiser_upsell_create_recurring($master_order);
  // Grab and process the thank you content if successful.
  if ($success) {
    // Add the campaign id to all recurring orders.
    if (!empty($campaign_id)) {
      fundraiser_upsell_set_recurring_campaigns($master_order->order_id, $campaign_id);
      $master_order->data['campaign_id'] = $campaign_id;
    }

    // Mark this order as an upsell.
    $master_order->data['upsell'] = TRUE;
    commerce_order_save($master_order);

    fundraiser_upsell_set_acceptance_cookie();

    // Get the full donation object for token replacement.
    $donation = fundraiser_donation_get_donation($master_order->order_id);

    // Send the thank you message.
    module_load_include('inc', 'fundraiser_upsell', 'includes/fundraiser_upsell.mail');

    // @todo Eventually we'll need a node here in order to get the thankyou
    // mail text when we do per node email wrappers settings.
    // Currently using the master order for token replacements.
    fundraiser_upsell_send_thank_you($master_order);

    // Generate the thank you content.
    // @todo Replace with per node thankyou message.
    // $raw_content = $donation->node->upsell['thankyou']
    // something like that.
    $raw_content = variable_get('fundraiser_upsell_thank_you_content', 'Thank you for your recurring donation!');
    $content = token_replace($raw_content, array('donation' => $donation), array('clear' => TRUE));

  }
  else {
    watchdog('fundraiser_upsell', 'Upsell failed for order %oid.', array('%oid' => $new_order->order_id), WATCHDOG_NOTICE);
    return 'There was a problem processing your order. Please try again.';
  }

  return $content;
}

/**
 * Convert the single donation into a recurring donation.
 *
 * @param object $order
 *   The order that will become the master order in the sustainer series.
 *
 * @return bool
 *   TRUE on successful creation of sustainers in the series.
 *
 */
function fundraiser_upsell_create_recurring($order) {
  // Since this is decoupled, we need to set the start date to ensure that we
  // advance the future orders by one month.
  $date_to_start = $order->data['date_to_start'];
  unset($order->data['date_to_start']);
  // Create the recurring orders.
  // @todo This function doesn't exist. Refactor.
  fundraiser_create_future_orders($order->order_id, NULL, $date_to_start);
  // Set the master id to show it's recurring.
  db_query("UPDATE {fundraiser_webform_order} SET recurring_status = 1 WHERE order_id = %d", $order->order_id);

  if (fundraiser_upsell_check_recurring($order->order_id)) {
    return TRUE;
  }

  return FALSE;
}

/**
 * Implements hook_queue_batch_item_alter().
 *
 * Add the upsell campaign id & initial upsell donation id.
 *
 * @todo I don't think this hook exists any more.
 */
function fundraiser_upsell_queue_batch_item_alter(&$object, $type, $action, $oid) {
  // Process single donations.
  if ($type == FUNDRAISER_SINGLE_DONATION_TYPE) {
    $order = uc_order_load($oid);
    // Set the campaign id if its been added.
    if (isset($order->data['campaign_id'])) {
      $object['CampaignId'] = $order->data['campaign_id'];
    }
    // Limit to update operations because that's when opportunities
    // that are part of a recurring series get updated.
    if ($action == 'update') {
      // Make sure the SF field exists.
      if (_fundraiser_upsell_check_sf_field('Opportunity', 'Initial_Upsell_Donation__c')) {
        // Get the master order id & its sfid.
        $master_order_id = db_result(db_query("SELECT master_order_id FROM {fundraiser_recurring} WHERE order_id = %d", $oid));
        // Load the master order id and pop out the initial_donation.
        // @todo Maybe query directly to avoid overhead of uc_order_load
        $master_order = uc_order_load($master_order_id);

        // If cloned_from is set, this is a donation that is part of a
        // decoupled upsell.
        // In this case we want the SFID of the original,
        // which is the order id stored in cloned_from.
        if ($master_order->data['cloned_from']) {
          $sfid = salesforce_management_api_id_load('donation', $master_order->data['cloned_from']);
          $object['Upsell_Order_ID__c'] = $master_order->data['cloned_from'];
        }
        // Normal upsell. Master order id is the original.
        elseif ($master_order->data['upsell']) {
          $object['Upsell_Order_ID__c'] = $master_order->order_id;
          $sfid = salesforce_management_api_id_load('donation', $master_order->order_id);
        }

        // Set the original order SFID.
        if (!empty($sfid)) {
          $object['Initial_Upsell_Donation__c'] = $sfid['sfid'];
        }
      }
    }
  }
  // Process recurring donations.
  if ($type == FUNDRAISER_RECURRING_DONATION_TYPE) {
    $order = uc_order_load($oid);
    // Make sure the SF field exists & we have the sfid.
    // This should really only process on an update
    // and after the postprocess hook below.
    $field_exists = _fundraiser_upsell_check_sf_field('npe03__Recurring_Donation__c', 'Initial_Upsell_Donation__c');

    // If cloned_from is set,
    // this is a donation that is part of a decoupled upsell.
    if ($field_exists && isset($order->data['cloned_from'])) {
      switch ($action) {
        case 'create':
          $object['Initial_Upsell_Order_Id__c'] = $order->data['cloned_from'];
          break;

        case 'update':
          // Get SFID stored on the original order
          // after the recurring donation is exported.
          $object['Initial_Upsell_Donation__c'] = $order->data['initial_donation'];
          break;
      }
    }
    // Normal upsell.
    elseif ($field_exists && isset($order->data['upsell'])) {
      switch ($action) {
        case 'create':
          $object['Initial_Upsell_Order_Id__c'] = $order->order_id;
          break;

        case 'update':
          // Get SFID stored on the original order
          // after the recurring donation is exported.
          $object['Initial_Upsell_Donation__c'] = $order->data['initial_donation'];
          break;
      }
    }

  }
}

/**
 * Implements hook_queue_postprocess_batch().
 *
 * Add the initial upsell sfid to the master order.
 *
 * @todo I don't think this hook exists any more.
 */
function fundraiser_upsell_queue_postprocess_batch($batch, $responses, $items_in_batch) {
  // Only process single donation batches that are successful and recurring.
  $is_recurring = fundraiser_upsell_check_recurring($batch['records'][0]->oid);
  if ($batch['type'] == FUNDRAISER_SINGLE_DONATION_TYPE && $responses[0]->success && $is_recurring) {
    // The first item is the master order.
    $order = uc_order_load($batch['records'][0]->oid);
    // Get the initial order and its sfid.
    $initial_order_id = (isset($order->data['cloned_from'])) ? $order->data['cloned_from'] : $order->order_id;
    $sfid = salesforce_management_api_id_load('donation', $initial_order_id);
    // Add the sfid to the order object.
    $order->data['initial_donation'] = $sfid['sfid'];
    uc_order_save($order);
    // Put in queue as recurring donation.
    sf_queue_insert($order->order_id, FUNDRAISER_RECURRING_DONATION_TYPE, 'update');
  }
}

/**
 * Implements hook_node_insert().
 */
function fundraiser_upsell_node_insert($node) {
  // Only process if upsell is enabled.
  if (fundraiser_upsell_is_enabled($node)) {
    // Insert the record.
    $record = fundraiser_upsell_node_record($node);
    drupal_write_record('fundraiser_upsell', $record);
  }
}

/**
 * Implements hook_node_update().
 */
function fundraiser_upsell_node_update($node) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($node->type)) {
    // Check if the upsell data already exists.
    $exists = db_query('SELECT nid FROM {fundraiser_upsell} WHERE nid = :nid',
      array(':nid' => $node->nid)
    )->fetchField();
    $record = fundraiser_upsell_node_record($node);
    // If upsell is enabled and the record doesn't exist then insert new row.
    if (empty($exists) && fundraiser_upsell_is_enabled($node)) {
      drupal_write_record('fundraiser_upsell', $record);
    }
    // If the record does exist, then update it.
    elseif (!empty($exists)) {
      drupal_write_record('fundraiser_upsell', $record, 'nid');
    }
  }
}

/**
 * Implements hook_node_load().
 */
function fundraiser_upsell_node_load($nodes, $types) {
  foreach ($nodes as $node) {
    // If this isn't a fundraiser type, ignore it.
    if (fundraiser_is_donation_type($node->type)) {
      $upsell = db_query('
        SELECT * FROM {fundraiser_upsell} WHERE nid = :nid',
        array(':nid' => $node->nid)
      )->fetchAssoc();
      // Merge data from upsell settings with node.
      unset($upsell['nid']);
      $nodes[$node->nid]->upsell = $upsell;
    }
  }
}

/**
 * Implements hook_node_delete().
 */
function fundraiser_upsell_node_delete(&$node) {
  db_query('DELETE FROM {fundraiser_upsell} WHERE nid = :nid', array(':nid' => $node->nid));
}

/**
 * Output an array of the DB structure mapped to the $node object.
 */
function fundraiser_upsell_node_record($node) {

  $campaign_id = !empty($node->fundraiser_upsell['campaign_id']) ? $node->fundraiser_upsell['campaign_id'] : '';

  return array(
    'nid' => $node->nid,
    'enabled' => $node->fundraiser_upsell['enabled'],
    'content' => $node->fundraiser_upsell['content'],
    'footer' => $node->fundraiser_upsell['footer'],
    'thankyou' => $node->fundraiser_upsell['thankyou'],
    'class' => $node->fundraiser_upsell['modal_theme']['class'],
    'width' => $node->fundraiser_upsell['modal_theme']['width'],
    'height' => $node->fundraiser_upsell['modal_theme']['height'],
    'campaign_id' => $campaign_id,
  );
}

/**
 * Implements hook_theme().
 */
function fundraiser_upsell_theme() {
  $theme = array(
    'fundraiser_upsell_modal' => array(
      'variables' => array(
        'width' => 400,
        'height' => 300,
        'class' => '',
        'rejection_days' => '180',
        'content' => '',
        'footer' => '',
        'sid' => NULL,
        'preview' => FALSE,
      ),
    ),
  );

  return $theme;
}

function theme_fundraiser_upsell_modal($variables) {
  // Add the css & js.
  $path = drupal_get_path('module', 'fundraiser_upsell');
  drupal_add_css($path . '/css/fundraiser_upsell.css');
  drupal_add_js($path . '/js/fundraiser_upsell.js');
  drupal_add_js($path . '/js/jquery.blockUI.js');

  $settings = array(
    'width' => $variables['width'],
    'height' => $variables['height'],
    'rejectionDays' => $variables['rejection_days'],
  );
  drupal_add_js(array('fundraiser_upsell' => $settings), 'setting');

  $upsell_size = 'width:' . $variables['width'] . 'px;height:' . $variables['height'] . 'px;';

  $content = '<div id="message-wrapper" class="hidden">';
  $content .= '<div id="message-modal" class="live-modal ' . $variables['class'];
  $content .= '" style="' . $upsell_size . '">';
  $content .= '<div class="message-content">' . $variables['content'] . '</div>';

  $form = drupal_get_form('fundraiser_upsell_donation_form', $variables['sid']);
  $content .= drupal_render($form);

  $content .= '<div id="message-disclaimer">' . $variables['footer'] . '</div>';
  $content .= '</div></div>';

  return $content;
}

/**
 * Generate the render array for the upsell form and thank you response.
 *
 * @param object $node
 *   The webform donation node object.
 * @param int $sid
 *   The user's specific submission ID for the donation node.
 *
 * @return array
 *   A render array for generating the content.
 */
function fundraiser_upsell_content($node, $sid) {
  // Add the css & js.
  $path = drupal_get_path('module', 'fundraiser_upsell');
  drupal_add_css($path . '/css/fundraiser_upsell.css');
  drupal_add_js($path . '/js/fundraiser_upsell.js');
  drupal_add_js($path . '/js/jquery.blockUI.js');
  // Get the size and class for the modal.
  $width = (!empty($node->upsell['modal_width'])) ? $node->upsell['modal_width'] : 400;
  $height = (!empty($node->upsell['modal_height'])) ? $node->upsell['modal_height'] : 300;
  $upsell_size = 'width:' . $width . 'px;height:' . $height . 'px;';
  // Pass values to javascript.
  $rejection_days = variable_get('fundraiser_upsell_rejection_lifetime', '180');
  $settings = array(
    'width' => $width,
    'height' => $height,
    'rejectionDays' => $rejection_days,
  );
  drupal_add_js(array('fundraiser_upsell' => $settings), 'setting');
  // Get the content for the form.
  $upsell_class = (!empty($node->upsell['class'])) ? $node->upsell['class'] : '';
  $upsell_content = (!empty($node->upsell['content'])) ? $node->upsell['content'] : variable_get('fundraiser_upsell_default_content', '');
  $upsell_disclaimer = variable_get('fundraiser_upsell_default_content_disclaimer', '');

  // Build the output.
  $prefix = '<div id="message-wrapper" class="hidden">';
  $prefix .= '<div id="message-modal" class="live-modal ' . $upsell_class;
  $prefix .= '" style="' . $upsell_size . '">';
  $prefix .= '<div class="message-content">' . $upsell_content . '</div>';

  $suffix .= '<div id="message-disclaimer">' . $upsell_disclaimer . '</div>';
  $suffix .= '</div></div>';

  $form = drupal_get_form('fundraiser_upsell_donation_form', $sid);
  $form['#prefix'] = $prefix;
  $form['#suffix'] = $suffix;

  return $form;
}

/**
 * Generate the upsell and thank you content for preview.
 *
 * @param object $node
 *   The webform donation node object.
 *
 * @return array
 *   A render array for generating the content.
 */
function fundraiser_upsell_content_preview($node) {
  // Add the css & js.
  $path = drupal_get_path('module', 'fundraiser_upsell');
  drupal_add_css($path . '/css/fundraiser_upsell.css');
  drupal_add_js($path . '/js/fundraiser_upsell.js');
  drupal_add_js($path . '/js/jquery.blockUI.js');
  // Get the size and class for the modal.
  $width = (!empty($node->upsell['modal_width'])) ? $node->upsell['modal_width'] : 400;
  $height = (!empty($node->upsell['modal_height'])) ? $node->upsell['modal_height'] : 300;
  $upsell_size = 'width:' . $width . 'px;height:' . $height . 'px;';
  // Pass values to javascript.
  $rejection_days = variable_get('fundraiser_upsell_rejection_lifetime', '180');
  $settings = array(
    'width' => $width,
    'height' => $height,
    'rejectionDays' => $rejection_days,
  );
  drupal_add_js(array('fundraiser_upsell' => $settings), 'setting');
  // Get the content for the form.
  $upsell_class = (!empty($node->upsell['class'])) ? $node->upsell['class'] : '';
  $upsell_content = (!empty($node->upsell['content'])) ? $node->upsell['content'] : variable_get('fundraiser_upsell_default_content', '');
  $upsell_disclaimer = variable_get('fundraiser_upsell_default_content_disclaimer', '');
  $upsell_thankyou_text = variable_get('fundraiser_upsell_thank_you_content', 'Thank you for your recurring donation!');
  $upsell_thankyou = token_replace_multiple($upsell_thankyou_text, array(
      'global' => NULL,
      'order' => NULL,
      'domain' => NULL,
    ));
  // Build the output.
  $content = '<div id="upsell-preview">This is a preview of the upsell and thank you content for this form.</div>';
  $content .= '<div id="message-wrapper" class="hidden">';
  $content .= '<div id="message-modal" class="preview-modal ' . $upsell_class;
  $content .= '" style="' . $upsell_size . '">';
  $content .= '<div class="message-content">' . $upsell_content . '</div>';
  $content .= drupal_get_form('fundraiser_upsell_donation_form', 0);
  $content .= '<div id="message-disclaimer">' . $upsell_disclaimer . '</div>';
  $content .= '</div></div>';
  // Add the thank you message for the preview.
  $content .= '<div id="message-return" class="hidden preview-modal thank-you ' . $upsell_class;
  $content .= '" style="' . $upsell_size . '"><div class="message-content">' . $upsell_thankyou . '</div></div>';

  return $content;
}

/**
 * Process the upsell donation form from the POSTed ajax callback.
 */
function fundraiser_upsell_ajax_process() {
  $data = $_POST;
  // Check the form token to be sure this is a valid callback.
  if (!drupal_valid_token($data['form_token'], $data['form_id'], TRUE)) {
    watchdog('fundraiser_upsell', 'Upsell order %oid failed because of an invalid form token.', array('%oid' => $order->order_id), WATCHDOG_NOTICE);
    $content = t('There was a problem with your order. Please try again');
  }
  else {
    $content = fundraiser_upsell_upsell_ajax_submit($data);
  }
  drupal_json_output($content);
}

/**
 * Determine if we should display the upsell preview for a node.
 *
 * Upsell must be enabled for the node and the user must have
 * the upsell permission.
 */
function fundraiser_upsell_preview_access($node) {
  return fundraiser_upsell_is_enabled($node) && user_access('administer fundraiser upsells');
}

/**
 * Access check that the user can use the upsell ajax callback for the node.
 *
 * This makes sure the upsell process call won't happen if the node doesn't
 * have upsell enabled.
 */
function fundraiser_upsell_access($node) {
  return fundraiser_upsell_is_enabled($node) && user_access('access content');
}

/**
 * Check the cookies and settings to see if upsell modal should be displayed.
 *
 * @return bool
 *   TRUE if the modal should be displayed.
 */
function fundraiser_upsell_should_display_modal() {
  $rejection = (!empty($_COOKIE['fundraiser_upsell_rejection'])) ? $_COOKIE['fundraiser_upsell_rejection'] : FALSE;
  $acceptance = (!empty($_COOKIE['fundraiser_upsell_acceptance'])) ? $_COOKIE['fundraiser_upsell_acceptance'] : FALSE;
  $debug = variable_get('fundraiser_upsell_debug', FALSE);

  // No cookies OR debug is on, then we should display the upsell.
  return ((!$rejection && !$acceptance) || $debug);
}

/**
 * Generate the order object from the sid.
 *
 * @param int $sid
 *   Submission ID.
 *
 * @return object
 *   The order.
 */
function fundraiser_upsell_get_order_by_sid($sid = NULL) {
  // Return empty object if no sid.
  if (empty($sid)) {
    return new stdClass();
  }
  // Otherwise look up and load the order object.
  $donation = db_query("
    SELECT *
    FROM {fundraiser_donation} AS fd, {fundraiser_upsell} AS fu
    WHERE fd.sid = :sid
    AND fd.nid = fu.nid", array(':sid' => $sid))->fetchAssoc();
  $order = commerce_order_load($donation['did']);
  // Add the donation & upsell info.
  $order->upsell = $donation;
  return $order;
}

/**
 * Determine if the node has upsell enabled.
 *
 * @return bool
 *   TRUE is upsell is enabled on this node.
 */
function fundraiser_upsell_is_enabled($node) {
  return (
    !empty($node)
    && fundraiser_is_donation_type($node->type)
    && !empty($node->upsell['enabled'])
    && $node->upsell['enabled']
  );
}

/**
 * Get the suggested amount from the admin bracket settings.
 *
 * @param int $amount
 *   The given amount.
 *
 * @todo Is amount an int or float?
 *
 * @return int
 *   The suggested amount to upsell to.
 *
 * @todo Is the return value an int or float?
 */
function fundraiser_upsell_find_suggested_amount($amount) {
  $default_upsell = 10;
  $brackets = variable_get('fundraiser_upsell_brackets', array());
  if (count($brackets) < 1) {
    return $default_upsell;
  }

  foreach ($brackets as $i => $bracket) {
    // If the amount is within the brackets, then use this upsell setting.
    if (($amount >= $bracket['low']) && ($amount <= $bracket['high'])) {
      return $bracket['upsell'];
    }
    // If this is the last loop and we don't have an upsell yet,
    // set it for the highest bracket.
    if ($i == count($brackets) - 1) {
      return $bracket['upsell'];
    }
  }
  return $default_upsell;
}

/**
 * Clone the order for decoupling.
 *
 * Clone the original order to a new order_id and set the value to $0.
 * Much of this comes from fundraiser_create_future_orders().
 *
 * @param object $order
 *   The order to clone.
 * @param array|NULL $options
 *   An array of options to be overridden in the cloned order.
 *   Currently only supports 'amount' and 'status' keys.
 *
 * @return object
 *   The new order object.
 *
 * @todo Review and refactor.
 */
function fundraiser_upsell_clone_order($order, $options = NULL) {
  // Create new order.
  $new_order = commerce_order_new($order->uid);
  // Copy all values to new order.
  $new_id = $new_order->order_id;
  $new_order = clone $order;
  $new_order->order_id = $new_id;
  // Make sure we know this is decoupled.
  $new_order->data['cloned_from'] = $order->order_id;
  // Set the proper status.
  $status = (isset($options['status'])) ? $options['status'] : $order->order_status;
  $new_order->order_status = $status;
  // Get the amount and set it.
  $amount = (isset($options['amount'])) ? $options['amount'] : $order->order_total;
  $new_order->products[0]->price = $amount;
  $new_order->order_total = $amount;
  // Calculate and set the start date.
  $date = new DateTime('NOW');
  // Make sure the payment is next month.
  $date->modify('next month');
  $date_to_start = strtotime($date->format('Y-m-d'));
  // Add this to the order data for later processing.
  $new_order->data['date_to_start'] = $date_to_start;
  // Remove the response from the original order.
  if (!empty($new_order->data['response'])) {
    unset($new_order->data['response']);
  }
  // Remove the old product id and save.
  unset($new_order->products[0]->order_product_id);
  commerce_order_save($new_order);
  // Add a comment to the order stating when it will be charged.
  // @todo This function doesn't exist.  Refactor.
  uc_order_comment_save($new_id, 0, t('Payment will be processed on !date.', array('!date' => date('n/j/Y', $date_to_start))), 'admin');
  // Add the new order to the fundraiser_recurring table
  // so it will be processed in the future.
  $gateway = $order->data['gateway'];
  $nid = $order->products[0]->nid;
  $sid = ($_GET['sid']) ? $_GET['sid'] : 0;
  // @todo This function doesn't exist.  Refactor.
  $donation_form_url = _fundraiser_donation_form_path($nid);
  db_query("
    INSERT INTO {fundraiser_recurring}
    (master_order_id, order_id, next_charge, gateway, form_url)
    VALUES (%d, %d, '%s', '%s', '%s')
    ", $new_id, $new_id, $date_to_start, $gateway, $donation_form_url);

  // Now add it to the fundraiser_webform_order table.
  db_query("
    INSERT INTO {fundraiser_webform_order}
    (webform_nid, order_id, sid, recurring_status, user_agent, form_url)
    VALUES (%d, %d, %d, %d, '%s', '%s')
    ", $nid, $new_id, $sid, $order->data['recurring_status'], $_SERVER['HTTP_USER_AGENT'], $donation_form_url);

  return $new_order;
}

/**
 * Check to see if a donation was successfully added as a recurring.
 *
 * @param int $did
 *   The donation ID of the master donation..
 *
 * @return bool
 *   Whether the donation has sustainer records (is recurring).
 */
function fundraiser_upsell_check_recurring($did) {
  return (fundraiser_sustainers_count_donations_in_series($did) > 0);
}

/**
 * Add a custom campaign ID to the recurring donations.
 *
 * Add a custom campaign id to the recurring donations in the data array for
 * each order. This will later be used to alter the batch hook and set
 * this campaign id for salesforce.
 *
 * @param int $master_order_id
 *   The order id for the master order.
 * @param string $campaign_id
 *   The campaign id to add to each order.
 */
function fundraiser_upsell_set_recurring_campaigns($master_order_id, $campaign_id) {
  // Grab the list of orders that are recurring in the series.
  $recurring = array();
  $result = db_query("SELECT * FROM {fundraiser_recurring} WHERE master_order_id = %d", $master_order_id);
  while ($row = db_fetch_array($result)) {
    $recurring[] = $row['order_id'];
  }
  // Loop through the list.
  foreach ($recurring as $order_id) {
    // Load the order, add the campaign id, and save the order again.
    $order = commerce_order_load($order_id);
    $order->data['campaign_id'] = $campaign_id;
    commerce_order_save($order);
  }
}

/**
 * Check that a field exists in Salesforce.
 *
 * @param string $type
 *   The Salesforce object type.
 * @param string $field_name
 *   The Salesforce field name to check.
 *
 * @return bool
 *   Whether the field exists.
 */
function _fundraiser_upsell_check_sf_field($type = 'Opportunity', $field_name = '') {
  // @todo This function doesn't exist.  Refactor.
  $objects = salesforce_management_api_fieldmap_objects('salesforce');
  return (isset($objects[$type]) && isset($objects[$type]['fields'][$field_name])) ? TRUE : FALSE;
}

/**
 * Determines if upsell should be available on this node.
 */
function fundraiser_upsell_is_available($node) {
  return (!empty($node) && fundraiser_is_donation_type($node->type));
}

/**
 * Set the fundraiser recurring acceptance cookie.
 */
function fundraiser_upsell_set_acceptance_cookie() {
  $cookie_lifetime = variable_get('fundraiser_upsell_acceptance_lifetime', 0);
  setcookie('fundraiser_upsell_acceptance', 1, REQUEST_TIME + 3600 * 24 * $cookie_lifetime, "/");
}
