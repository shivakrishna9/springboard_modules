<?php

/**
 * @file
 * Provides behaviors to handle donation form creation and donation submission.
 */

// Include theme related functions.
require_once('fundraiser.theme.inc'); //TODO merge this back in.

/**
 * Implements hook_permission().
 */
function fundraiser_permission() {
  return array(
    'administer fundraiser' => array(
      'title' => t('Administer fundraiser'),
      'description' => t('Perform administration tasks for fundraiser.'),
    ),
    'refund donations' => array(
      'title' => t('Refund donations'),
      'description' => t('Refund donations for fundraiser.'),
    ),
    'create donation form' => array(
      'title' => t('Create donation form'),
      'description' => t('Create donation forms.'),
    ),
    'edit own donation form' => array(
      'title' => t('Edit own donation form'),
      'description' => t('Edit own donation forms.'),
    ),
    'edit any donation form' => array(
      'title' => t('Edit any donation form'),
      'description' => t('Edit any donation forms.'),
    ),
    'delete own donation form' => array(
      'title' => t('Delete own donation form'),
      'description' => t('Delete own donation forms.'),
    ),
    'delete any donation form' => array(
      'title' => t('Delete any donation form'),
      'description' => t('Delete any donation forms.'),
    ),
    'clone donation form' => array(
      'title' => t('Clone donation form'),
      'description' => t('Clone donation forms.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function fundraiser_menu() {
  // Admin paths.
  $items['admin/config/system/fundraiser'] = array(
    'title' => 'Fundraiser',
    'description' => 'Configurations for the Fundraiser system.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fundraiser_admin_settings'),
    'access arguments' => array('administer fundraiser'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'fundraiser.admin.inc',
  );
  $items['admin/config/system/fundraiser/settings'] = array(
    'title' => 'Fundraiser',
    'description' => 'Configurations for the Fundraiser system.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fundraiser_admin_settings'),
    'access arguments' => array('administer fundraiser'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'file' => 'fundraiser.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_boost_is_cacheable().
 *
 * If Boost is enabled, make sure donation form nodes aren't cached.
 */
function fundraiser_boost_is_cacheable($parts) {
  $args = $parts['args'];
  if ($args[0] == 'node' && isset($args[1]) && is_numeric($args[1]) && !isset($args[2])) {
    // It's a node, but is it a donation node?
    $node = node_load($args[1]);
    if (fundraiser_is_donation_type($node)) {
      // Don't cache donation forms
      $parts['is_cacheable'] = FALSE;
    }
  }
  return $parts;
}

/**
 * Implements hook_token_info().
 */
function fundraiser_token_info() {
  // Add a donation type.
  $info['types']['donation'] = array(
    'name' => t('Current donation'),
    'description' => t('Tokens related to specific donations.'),
    'needs-data' => 'donation',
  );
  // Donation tokens by field.
  $info['tokens']['donation'] = _fundraiser_donation_token_info();
  // Donation basic data.
  $info['tokens']['donation']['did'] = array(
    'name' => t('Donation ID'),
    'description' => t('The unique ID of the donation.'),
  );
  $info['tokens']['donation']['node'] = array(
    'name' => t('Fundraiser Node'),
    'description' => t('The fundraiser node the donation came from.'),
    'type' => 'node',
  );
  $info['tokens']['donation']['user'] = array(
    'name' => t('Donating User'),
    'description' => t('The user account the donation came from.'),
    'type' => 'user',
  );
  // Modify given for payment fields.
  if (isset($info['tokens']['donation']['payment_fields'])) {
    // Payment token fields are generated by the gateway and are not predictable.
    // For the moment they are not available as tokens.
    unset($info['tokens']['donation']['payment_fields']);
    unset($info['tokens']['donation']['other_amount']);
  }
  return $info;
}

/**
 * Recursive to build up form info for tokens.
 */
function _fundraiser_donation_token_info($fields = NULL, $tokens = array()) {
  if ($fields == NULL) {
    $fields = fundraiser_field_info();
  }
  $children = element_children($fields);
  foreach ($children as $child) {
    // TODO Adjust this tokening to account for the new changed in donation fields.
    $disallowed = array('card_cvv');
    if (isset($fields[$child]['#type']) && $fields[$child]['#type'] != 'fieldset' && !in_array($child, $disallowed)) {
      // Add children.
      $tokens[$child] = array(
        'name' => isset($fields[$child]['#title']) ? $fields[$child]['#title'] : $child,
        'description' => t('Donation field information.'),
      );
    }
    else {
      // Recurse for more.
      $tokens = _fundraiser_donation_token_info($fields[$child], $tokens);
    }
  }
  return $tokens;
}

/**
 * Implements hook_tokens().
 */
function fundraiser_tokens($type, $tokens, $data = array(), $options = array()) {
  $replacements = array();
  if ($type = 'donation' && !empty($data['donation'])) {
    $donation = $data['donation'];
    // All set fields.
    $data = is_array($donation->donation) ? $donation->donation : array();
    // User and etc types.
    $data['did'] = isset($donation->did) ? $donation->did : '';
    $data['node'] = isset($donation->node->nid) ? $donation->node->nid : '';
    $data['user'] = isset($donation->user->uid) ? $donation->user->uid : '';
    // Specific changes for payment fields.
    if (isset($data['payment_fields'])) {
      // Payment token fields are generated by the gateway and are not predictable across all nodes.
      // Since the nodes are individually configurable. We wouldn't be able to predict any element.
      // For the moment they are not available as tokens.
      unset($data['payment_fields']);
    }
  }
  // Replace the given tokens.
  $replacements = array();
  foreach ($tokens as $key => $token) {
    if (isset($data[$key])) {
      $replacements[ $token ] = $data[$key];
    }
  }
  if ($node_tokens = token_find_with_prefix($tokens, 'node')) {
    $replacements += token_generate('node', $node_tokens, array('node' => $donation->node), $options);
  }
  if ($user_tokens = token_find_with_prefix($tokens, 'user')) {
    $replacements += token_generate('user', $user_tokens, array('user' => $donation->user), $options);
  }
  return $replacements;
}

/**
 * Implements hook_clone_access_alter() from Node clone module.
 */
function fundraiser_clone_access_alter(&$access, $node) {
  // Remove the access if the user isn't allowed to clone the donation form.
  if (!user_access('clone donation form')) {
    $access = 0;
  }
}

/**
 * Implements hook_clone_node_alter() from Node clone module.
 *
 * From: http://drupal.org/node/1256478
 */
function fundraiser_clone_node_alter(&$node, $context) {
  // Set the internal name.
  if (fundraiser_is_donation_type($context['original_node']->type)) {
    if (isset($context['original_node']->internal_name)) {
      $node->internal_name = t('Clone of @internal', array('@internal' => $context['original_node']->internal_name));
    }
  }
  // The additional load in hook_node_load already will have brought in additional node data.
  // The additional saves in hook_node_insert / hook_node_update will save the additional node data.
}

/**
 * Implements hook_views_api(). From Views module.
 */
function fundraiser_views_api() {
  return array(
    'api' => 2,
  );
}

/**
 * Implementshook_node_access().
 */
function fundraiser_node_access($node, $op, $account) {
   // Without an idea who the owner is or type is we can't assess access. So don't rock the boat.
  if ( isset($node->type) && isset($node->uid) && fundraiser_is_donation_type($node->type)) {
    $is_author = $account->uid == $node->uid;
    switch ($op) {
      case 'create':
        return user_access('create donation form', $account) ? NODE_ACCESS_ALLOW : NODE_ACCESS_IGNORE;
      case 'update':
        return ((user_access('edit own donation form', $account) && $is_author) ||
          user_access('edit any donation form', $account)) ? NODE_ACCESS_ALLOW : NODE_ACCESS_IGNORE;
      case 'delete':
        return ((user_access('delete own donation form', $account) && $is_author) ||
          user_access('delete any donation form', $account)) ? NODE_ACCESS_ALLOW : NODE_ACCESS_IGNORE;
    }
  }
}

/**
 * Implements hook_form_alter().
 *
 * Alter content type settings to add "Enable fundraiser?" checkbox.
 */
function fundraiser_form_node_type_form_alter(&$form, &$form_state) {
  if (isset($form['type'])) {
    $form['fundraiser_type'] = array(
      '#type' => 'fieldset',
      '#title' => t('Fundraiser settings'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#group' => 'additional_settings',
    );
    $form['fundraiser_type']['fundraiser'] = array(
      '#type' => 'checkbox',
      '#title' => t('Enable fundraiser?'),
      '#default_value' => variable_get('fundraiser_' . $form['#node_type']->type, FALSE),
      '#description' => t('Enable this checkbox if this content type should provide a donation field.'),
    );
  }
}

/**
 * Node API Functions. Handle for each case of node operation.
 */

/**
 * Implements hook_node_delete().
 */
function fundraiser_node_delete($node) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($node->type)) {
    _fundraiser_delete_fundraiser($node->nid);
    _fundraiser_delete_tracking($node->nid);
  }
}

/**
 * Implements hook_node_insert().
 */
function fundraiser_node_insert($node) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($node->type)) {
    _fundraiser_create_fundraiser($node);
  }
}

/**
 * Implements hook_node_load().
 */
function fundraiser_node_load($nodes, $types) {
  foreach ($nodes as $node) {
    // If this isn't a fundraiser type, ignore it.
    if (fundraiser_is_donation_type($node->type)) {
      // Get the fundraiser information.
      // This also loads additional data presented from other modules to FR.
      // AKA fundraiser_webform and fundraiser_profile data.
      $fundraiser = _fundraiser_get_fundraiser_by_nid($node->nid);
      // Merge data from fundraiser with node.
      $fundraiser = (array) $fundraiser;
      foreach ($fundraiser as $key => $value) {
        $nodes[$node->nid]->$key = $value;
      }
    }
  }
}

/**
 * Implements hook_node_presave().
 */
function fundraiser_node_presave($node) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($node->type) && isset($node->amount_wrapper)) {
    // Check the submission to remove the donation amounts marked.
    foreach ($node->amount_wrapper['donation_amounts'] as $index => $donation_amount) {
      // If the remove marker is set.
      if (isset($donation_amount['remove']) && $donation_amount['remove'] == 1) {
        unset($node->amount_wrapper['donation_amounts'][$index]);
      }
      unset($node->amount_wrapper['donation_amounts'][$index]['remove']);
      // Or if the values aren't set.
      if (empty($donation_amount['label']) && empty($donation_amount['amount'])) {
        unset($node->amount_wrapper['donation_amounts'][$index]);
      }
      unset($node->amount_wrapper['donation_amounts'][$index]['remove']);
    }
    // Set the donation amounts where we expect them to be for processing.
    // These are buried under amount_wrapper because we set 'TREE' on that in the form.
    $node->donation_amounts = $node->amount_wrapper['donation_amounts'];
    $node->show_other_amount = $node->amount_wrapper['show_other_amount'];
    $node->minimum_donation_amount = is_numeric($node->amount_wrapper['minimum_donation_amount']) ?
      $node->amount_wrapper['minimum_donation_amount'] : variable_get('fundraiser_default_minimum', 10.00);
    unset($node->amount_wrapper);
  }
}

/**
 * Implements hook_node_update().
 */
function fundraiser_node_update($node) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($node->type)) {
    _fundraiser_update_fundraiser($node);
  }
}

/**
 * Implements hook_node_validate().
 */
function fundraiser_node_validate($node, $form, &$form_state) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($node->type)) {
    // If each given amount if numeric, we're ok.
    // Since the form is set to TREE at this point, we need to account for that in our addressing path.
    foreach ($node->amount_wrapper['donation_amounts'] as $index => $donation_amount) {
      if (isset($donation_amount['amount']) && !empty($donation_amount['amount'])) {
        if (!is_numeric($donation_amount['amount'])) {
          form_set_error('donation_amounts', t('Ask amounts must be numeric, you entered "@s".', array("@s" => $donation_amount['amount'])));
          break;
        }
      }
    }
  }
}

/**
 * Implements hook_node_view().
 */
function fundraiser_node_view($node, $view_mode, $langcode) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($node->type)) {
    // Track the pageview.
    if ($view_mode == 'full') {
      _fundraiser_update_tracking_value($node->nid, 'pageviews');
    }

    // Messaging checks. We want to hide warning/admin messages if user can't
    // edit the current node.
    if ($view_mode == 'full' && node_access("update", $node)) {
      // Set a reminder to turn off development mode on the page view.
      if (variable_get('fundraiser_development_mode', 0)) {
        $link = l('turn off', 'admin/config/system/fundraiser');
        drupal_set_message(t('Fundraiser is currently running in development mode. Remember to ' .
          '!link this feature on production websites.',
           array('!link' => $link)));
      }
      // Throw a warning if no confirmation email has been configured.
      if (module_exists('email_wrappers') && !email_wrappers_load_settings($node->nid, NULL)) {
        drupal_set_message(t('Warning: no confirmation emails have been configured for this donation form.' .
          ' Users who submit a donation will not recieve an email confirming their donation.'), 'error');
      }
    }

  }
  // NOTE: Glue display modules are responsible for using hook_node_view to display themselves with the node.
  // Some, like webform based glue modules, already do the work of displaying on a form themselves.
}

/**
 * Fundraiser form modification functions.
 */

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node forms.
 */
function fundraiser_form_node_form_alter(&$form, &$form_state, $form_id) {
  // If this isn't a fundraiser type, ignore it.
  if (fundraiser_is_donation_type($form['#node']->type)) {
    _fundraiser_donation_settings_form($form, $form_state);
    // Other modules that need to add to the settings form should also implement
    // hook_form_BASE_FORM_ID_alter, or any of the other form alter hooks.
  }
}

/**
 * Fundraiser form. This form collects the information to create donation forms per donation node types.
 * This is added to the node display via form_alter when editting nodes of the correct type.
 *
 * It ultimately populates the fundraiser table from which donation forms are created :
 * nid, gateway, receipt_email_from, receipt_email_address, receipt_email_subject, receipt_email_message,
 * donation_amounts, show_other_amount, minimum_donation_amount, internal_name, confirmation_page_title,
 * confirmation_page_body, confirmation_page_format, redirect_url.
 */
function _fundraiser_donation_settings_form(&$form, &$form_state) {
  // Load the node up from form data so we have everything.
  if (empty($node) && isset($form['#node'])) {
    $node = $form['#node'];
  }
  // Check if this is being called on an enabled node type.
  if (!fundraiser_is_donation_type($node->type)) {
    return;
  }
  // Add additional js and css for this form.
  drupal_add_css(drupal_get_path('module', 'fundraiser') . '/css/fundraiser.css');
  drupal_add_js(drupal_get_path('module', 'fundraiser') . '/js/fundraiser_form.js');
  // Fundraiser values are loaded by hook_node_load() on the node type.
  // So we can safely assume any associated fundraiser information is already available.
  // Now create form elements for everything we need to set.
  $form['internal_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Internal name'),
    '#required' => TRUE,
    '#default_value' => isset($node->internal_name) ? $node->internal_name : '',
    '#weight' => -4.99,
    '#maxlength' => 255,
  );
  $form['fundraiser_settings'] = array(
    '#type' => 'fieldset',
    '#title' => t('Fundraiser settings'),
    '#weight' => -4.96,
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'additional_settings',
  );
  // Get avaiable gateways and provide an interface on the fundraiser settings to edit the payment_method fields later.
  $gateway_options = array();
  $gateways = _fundraiser_gateway_info();
  if (empty($gateways)) {
    $form['fundraiser_settings']['gateways'] = array(
      '#markup' => '<div>' . t('There are no gateways configured. Please create some gateways in the store configuration.') . '</div>',
    );
  }
  else {
    $fieldset = array(
      '#type' => 'fieldset',
      '#title' => t('Payment methods'),
      '#description' => t('Enable donation form payment methods and their corresponding gateways.'),
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
      '#tree' => TRUE,
      '#theme' => 'fundraiser_form_payment_methods',
    );
    foreach($gateways as $gateway) {
      $types = isset($gateway['payment_method']) ? $gateway['payment_method'] : array();
      foreach ($types as $type) {
        $all_payment_methods[$type][] = $gateway;
      }
    }
    // Sort all payment methods by the configured weight of the fields
    foreach (array_keys($all_payment_methods) as $method_key) {
      $all_payment_methods[$method_key]['weight'] = !empty($node->gateways[$method_key]['weight']) ? $node->gateways[$method_key]['weight'] : 0;
    }
    uasort($all_payment_methods, '_fundraiser_payment_method_weight_compare');
    $method_count = count($all_payment_methods);
    // Loop through each method, comparing to those set on this node.
    foreach ($all_payment_methods as $method_key => $method) {
      // Remove the weight value
      unset($method['weight']);
      $field_method_settings = isset($node->gateways[$method_key]) ? $node->gateways[$method_key] : array();
      // Build the #options array for the payment processors supporting this payment method.
      $processor_options = array(NULL => '- ' . t('select') . ' -');
      foreach (element_children($method) as $key) {
        $processor_options[ $method[$key]['id'] ] = $method[$key]['title'];
      }
      $fieldset[$method_key] = array('#tree' => TRUE);
      $fieldset[$method_key]['status'] = array(
        '#type' => 'checkbox',
        '#default_value' => isset($field_method_settings['status']) ? $field_method_settings['status'] : 0,
      );
      // Add auto check.
      if ($method_count == 1) {
        $fieldset[$method_key]['status']['#default_value'] = TRUE;
      }
      $fieldset[$method_key]['_status'] = array(
        '#type' => 'markup',
        '#title' => t('Method'),
        '#markup' => $method_key, // Could use a pretty name here
      );
      $fieldset[$method_key]['method'] = array(
        '#type' => 'value',
        '#value' => $method_key,
      );
      $fieldset[$method_key]['id'] = array(
        '#type' => 'select',
        '#title' => t('Payment Processor'),
        '#description' => t('The payment processor for this payment method.'),
        '#options' => $processor_options,
        '#default_value' => isset($field_method_settings['id']) ? $field_method_settings['id'] : NULL,
      );
      // Add auto select.
      if ($method_count == 1 && count($processor_options) == 2) {
        $keys = array_keys($processor_options);
        $fieldset[$method_key]['id']['#default_value'] = $keys[1];
      }
      // Include these fields if there is more than one payment method.
      if ($method_count > 1) {
        $fieldset[$method_key]['label'] = array(
          '#type' => 'textfield',
          '#description' => t('The label displayed for this payment method. Required when multiple payment methods are enabled.'),
          '#title' => t('Label'),
          '#size' => 20,
          '#default_value' => isset($field_method_settings['label']) ? $field_method_settings['label'] : NULL,
        );
        $fieldset[$method_key]['weight'] = array(
          '#type' => 'weight',
          '#title' => t('Weight'),
          '#delta' => 25,
          '#default_value' => isset($field_method_settings['weight']) ? $field_method_settings['weight'] : 0,
          '#attributes' => array('class' => array('fundraiser-payment-methods-weight')),
        );
        $fieldset[$method_key]['_default'] = array(
          '#type' => 'radio',
          '#title' => t('Default'),
          '#default_value' => !empty($field_method_settings['default']) ? $method_key : NULL,
          '#return_value' => $method_key,
          '#parents' => array('gateways', '_default'),
        );
      }
    }
    $form['fundraiser_settings']['gateways'] = $fieldset;
    // add a validate callback.
    $form['#validate'][] = '_fundraiser_form_payment_method_validate';
  }

  // Add specific CSS settings for IE support. Pending http://drupal.org/node/1015798 being resolved,
  // and UC Store accounting for that update. (Should be block not inline-block).
  $style = '.vertical-tabs fieldset fieldset legend {display: block;}';
  drupal_add_css($style, 'inline');
  $form['fundraiser_settings']['amount_wrapper'] = array(
    '#type' => 'fieldset',
    '#title' => t('Ask amounts'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#prefix' => '<div class="clear-block" id="ask-wrapper">',
    '#suffix' => '</div>',
    '#tree' => TRUE, // This is important, this allows the deltas below to function as part of the array.
  );
  $form['fundraiser_settings']['amount_wrapper']['donation_amounts'] = array(
    '#prefix' => '<div id="ask-amounts">',
    '#suffix' => '</div>',
    '#theme' => 'fundraiser_ask_amounts',
  );

  // AJAXy bits.
  $donation_amounts = array();
  // The last submission takes precedence.
  if (isset($form_state['values']['amount_wrapper']['donation_amounts'])) {
    foreach ($form_state['values']['amount_wrapper']['donation_amounts'] as $index => $values) {
      $donation_amounts[] = array($values['amount'], $values['label']);
    }
  }
  else {
    // If the form hasn't been submitted, then grab the defaults from the node or empty.
    // Donation amounts were loaded on node_load, and exploded at that time. If they exist, they're on the node.
    $donation_amounts = isset($node->donation_amounts) ? $node->donation_amounts : array();
    // If not there, then grab some defaults.
    if (count($donation_amounts) == 0) {
      $default_amounts = variable_get('fundraiser_default_amounts', '10|$10'."\n".'20|$20'."\n".'50|$50'."\n".'100|$100');
      $default_amounts = explode("\n", $default_amounts);
      $default_amounts = array_unique($default_amounts);
      $exploded_amounts = array();
      foreach ($default_amounts as $default_amount) {
        $these_amounts = explode('|', $default_amount);
        if (count($these_amounts) == 1) {
          $these_amounts[1] = '$' . $these_amounts[0];
        }
        $exploded_amounts[] = $these_amounts;
      }
      $donation_amounts = $exploded_amounts;
    }
  }
  // Default provide one spare blank for users to fill in.
  // If the button clicked was to add another, this line will add an extra field as expected on reload.
  $donation_amounts[] = array('', '');
  // Generate a form set for each existing amount. (To be themed into table format.)
  foreach ($donation_amounts as $donation_amount) {
    // Filter out other|Other combinations. We don't want to display those in this form.
    // And if we did, the value would fail validation (not a number).
    // There is probably a better way to track this, but for now this'll do.
    if ($donation_amount[0] != 'other') {
      $form['fundraiser_settings']['amount_wrapper']['donation_amounts'][] = _fundraiser_ask_form($donation_amount);
    }
  }
  $form['fundraiser_settings']['amount_wrapper']['help'] = array(
    '#value' => '<p>' . t('If you want the user to choose from a predetermined list donation amounts, enter them here. ' .
      'If no amounts are entered, a textbox will be displayed for the user to enter a custom amount.') . '</p>',
  );
/*
// Removed for the moment, cause AJAX is NOT cooperating $form_state['values'] is not getting set.
// I have no idea why, the examples given at d.o indicate this is the right way to do this.
  $form['fundraiser_settings']['amount_wrapper']['amount_more'] = array(
    '#type' => 'submit',
    '#value' => t('Add another'),
    '#description' => t('Click here to add more choices.'),
    '#ajax' => array(
      'callback' => '_fundraiser_donation_settings_form_amounts',
      'wrapper' => 'ask-amounts',
      'method' => 'replace',
      'effect' => 'fade',
    ),
  );
 */
  // Additional fundraiser settings.
  $form['fundraiser_settings']['amount_wrapper']['show_other_amount'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show other amount option'),
    '#description' => t('Use this option if you want to provide an "Other Amount" field in conjunction with the list ' .
      'of Donation Amounts.'),
    '#default_value' => isset($node->show_other_amount) ? $node->show_other_amount : variable_get('fundraiser_default_other', TRUE),
  );
  $form['fundraiser_settings']['amount_wrapper']['minimum_donation_amount'] = array(
    '#type' => 'textfield',
    '#title' => t('Minimum donation amount'),
    '#description' => t('The minimum acceptable donation amount.'),
    '#default_value' => isset($node->minimum_donation_amount) ?
      number_format($node->minimum_donation_amount, 2) : variable_get('fundraiser_default_minimum', 10.00),
  );

  $form['#validate'][] = '_fundraiser_form_amounts_validate';
  // TODO this should probably go on a different table, not here.
  /* Hidden fields. These are set later on other forms, included here to prevent overwrite during saves. */
  $form['receipt_email_from'] = array(
    '#type' => 'value',
    '#value' => isset($node->receipt_email_from) ? $node->receipt_email_from : '',
  );
  $form['receipt_email_address'] = array(
    '#type' => 'value',
    '#value' => isset($node->receipt_email_address) ? $node->receipt_email_address : '',
  );
  $form['receipt_email_subject'] = array(
    '#type' => 'value',
    '#value' => isset($node->receipt_email_subject) ? $node->receipt_email_subject : '',
  );
  $form['receipt_email_message'] = array(
    '#type' => 'value',
    '#value' => isset($node->receipt_email_message) ? $node->receipt_email_message : '',
  );
  //$form['#after_build'][] = '_fundraiser_validation_includes';
}

/**
 * Validate handler for our component, also sets the default value
 */
function _fundraiser_form_payment_method_validate($form, &$form_state) {
  // Check the set payment methods.
  $values = $form_state['values']['gateways'];
  $default_method = isset($values['_default']) ? $values['_default'] : '';
  $enabled_methods = array_filter($values, '_fundraiser_payment_method_array_filter_enabled');
  unset($form_state['values']['gateways']['_default']);
  unset($enabled_methods['_default']);
  // Check that there is at least one method enabled
  if (empty($enabled_methods)) {
    form_set_error('payment_methods', t('At least one payment method must be enabled.'));
  }
  else {
    // Check that the marked payment type actually have selected gateways to match.
    foreach ($enabled_methods as $method => $enabled_method) {
      if (empty($enabled_method['id'])) {
        form_set_error('gateways][' . $method .'][id', t('All enabled payment methods must select a gateway.'));
      }
      if (count($enabled_methods) > 1 && empty($enabled_method['label'])) {
        form_set_error('gateways][' . $method .'][label', t('Please enter a label for the %method gateway.', array('%method' => $method)));
      }
    }
    // Check that a default has been set.
    if (!isset($enabled_methods[$default_method])) {
      if (count($enabled_methods) == 1) {
        $default_method = key($enabled_methods);
        $form_state['values']['gateways'][$default_method]['default'] = 1;
      }
      else {
        form_set_error('fundraiser_settings][gateways][_default', t('Default method must be one of the enabled methods.'));
      }
    }
    else {
      $form_state['values']['gateways'][$default_method]['default'] = 1;
    }
  }
}

/**
 * Validate handler for amounts configuration.
 */
function _fundraiser_form_amounts_validate($form, &$form_state) {
  // Check the ask amounts, if we have a label and we dong have an amount, throw a fit.
  // If we have neither, assume it's meant to be empty and leave it be (it will be removed).
  $amounts = $form_state['values']['amount_wrapper']['donation_amounts'];
  foreach ($amounts as $index => $amount_set) {
    if (!empty($amount_set['amount']) && empty($amount_set['label'])) {
      form_set_error('amount_wrapper][donation_amounts][' . $index . '][label',
        t('The label cannot be empty when an amount is set.'));
    }
    if (empty($amount_set['amount']) && !empty($amount_set['label'])) {
      form_set_error('amount_wrapper][donation_amounts][' . $index . '][amount',
        t('The amount cannot be empty when a label is set.'));
    }
    if (!is_numeric($amount_set['amount']) && !empty($amount_set['amount'])) {
      form_set_error('amount_wrapper][donation_amounts][' . $index . '][amount',
        t('The amount must be a number.'));
    }
  }

  // Checking the minimum amount.
  $minimum_donation_amount = $form_state['values']['amount_wrapper']['minimum_donation_amount'];
  if (!empty($minimum_donation_amount) && !is_numeric($minimum_donation_amount)) {
    form_set_error('amount_wrapper][minimum_donation_amount', t('The minimum donation amount must be a numerical value.'));
  }
}

/**
 * Array_filter callback for filtering by method status.
 */
function _fundraiser_payment_method_array_filter_enabled($method_settings) {
  return !empty($method_settings['status']);
}

/**
 * Sort payment methods by weight
 */
function _fundraiser_payment_method_weight_compare($a, $b) {
  $weight = $a['weight'] - $b['weight'];
  return $weight;
}

/**
 * Generate donation ask amount fields, used by donation form
 */
function _fundraiser_ask_form($amount_values = array()) {
  $form['amount'] = array(
    '#type' => 'textfield',
    '#default_value' => isset($amount_values[0]) ? $amount_values[0] : '',
    '#size' => 10,
  );
  $form['label'] = array(
    '#type' => 'textfield',
    '#default_value' => isset($amount_values[1]) ? $amount_values[1] : '',
    '#size' => 30,
  );
  $form['remove'] = array(
    '#type' => 'checkbox',
    '#return_value' => 1,
    '#default_value' => 0,
  );
  return $form;
}

/**
 * Callback handler for the donation ask amount form #ajax.
 */
function _fundraiser_donation_settings_form_amounts($form, $form_state) {
  return $form['fundraiser_settings']['amount_wrapper']['donation_amounts'];
}

/**
 * Donation field definitions.
 */

/**
 * Provides a list of fields to be defined by the display module. Requests additional field information from other modules that need to define them.
 */
function fundraiser_field_info() {
  static $fields;
  // Cache fundraiser content types during page execution.
  if (empty($fields)) {
    // Request additional fields from other modules.
    $fields = module_invoke_all('fundraiser_field_info');
    // Allow for others to modify as needed.
    drupal_alter('fundraiser_field_info', $fields);
  }
  // And return.
  return $fields;
}

/**
 * Implements hook_fundraiser_field_info(), providing the core set of fields that fundraiser must have.
 */
function fundraiser_fundraiser_field_info() {
  // Donation amounts are handled in a special case.
  $fields['donation'] = array(
    '#title' => t('Donation'),
    '#type' => 'fieldset',
    '#required' => 0,
  );
  $fields['donation']['amount'] = array(
    '#title' => t('Amount'),
    '#type' => 'textfield',
    '#required' => 1,
    '#extra' => array(
      'description' => '',
      'width' => 10,
      'field_prefix' => '$',
    ),
    '#allow_update' => 1,
    '#create_callback' => '_fundraiser_amount_field_create',
  );
  $fields['donation']['other_amount'] = array(
    '#title' => t('Other'),
    '#type' => 'textfield',
    '#required' => 0,
    '#extra' => array(
      'description' => t('Minimum payment $ @min.', array('@min' => number_format(variable_get('fundraiser_default_minimum', 10.00), 2))),
      'width' => 10,
      'field_prefix' => '$',
    ),
    '#allow_update' => 1,
    '#create_callback' => '_fundraiser_other_amount_field_create',
    '#validate_callback' => '_fundraiser_other_amount_field_validate',
  );
  $fields['donor_information'] = array(
    '#title' => t('Your Information'),
    '#type' => 'fieldset',
    '#required' => 0,
  );
  $fields['donor_information']['first_name'] = array(
    '#title' => t('First Name'),
    '#type' => 'textfield',
    '#required' => 1,
  );
  $fields['donor_information']['last_name'] = array(
    '#title' => t('Last Name'),
    '#type' => 'textfield',
    '#required' => 1,
  );
  $fields['donor_information']['mail'] = array(
    '#title' => t('E-mail address'),
    '#type' => 'email',
    '#required' => 1,
    '#validate_callback' => '_fundraiser_email_field_validate',
  );
  $fields['billing_information'] = array(
    '#title' => t('Billing Information'),
    '#type' => 'fieldset',
    '#required' => 0,
  );
  $fields['billing_information']['address'] = array(
    '#title' => t('Address'),
    '#type' => 'textfield',
    '#required' => 1,
  );
  $fields['billing_information']['address_line_2'] = array(
    '#title' => t('Address Line 2'),
    '#type' => 'textfield',
    '#required' => 0,
  );
  $fields['billing_information']['city'] = array(
    '#title' => t('City'),
    '#type' => 'textfield',
    '#required' => 1,
  );
  $fields['billing_information']['country'] = array(
    '#title' => t('Country'),
    '#type' => 'textfield',
    '#required' => 1,
  );
  $fields['billing_information']['state'] = array(
    '#title' => t('State/Province'),
    '#type' => 'textfield',
    '#required' => 1,
  );
  $fields['billing_information']['zip'] = array(
    '#title' => t('ZIP/Postal Code'),
    '#type' => 'textfield',
    '#required' => 1,
    '#extra' => array(
      'description' => '',
      'width' => 10,
      'maxlength' => 5,
    ),
  );
  $fields['payment_information'] = array(
    '#title' => t('Payment Information'),
    '#type' => 'fieldset',
    '#required' => 0,
  );
  /**
   * These two fields are intended to hold the payment method information
   * And the array of user entered data for the payment method.
   * They replace previous implementations relying on CC fields.
   */
  $fields['payment_information']['payment_method'] = array(
    '#title' => t('Payment Method'),
    '#type' => 'payment_method',
    '#required' => 1,
    '#allow_update' => 1,
    '#create_callback' => '_fundraiser_payment_method_field_create',
  );
  $fields['payment_information']['payment_fields'] = array(
    '#title' => t('Payment Details'),
    '#type' => 'payment_fields',
    '#required' => 0,
    /**
     * Instead of returning the value of this field it's treated more like a variable fieldset.
     * The values returned are dependant on the value returned by payment method by gateway.
     * In the format:
     * 'payment_fields' => array(
     *   'credit' => array(
     *     'card_number' => '',
     *     'card_expiration_month' => '',
     *     'card_expiration_year' => '',
     *     'card_cvv' => '',
     *   )
     *   'paypal' => array(
     *     'paypal_email' => '',
     *   )
     *   'debit' => array(
     *     'debit_routing' => '',
     *     'debit_account' => '',
     *   )
     * );
     */
  );
  return $fields;
}

/**
 * Field callback, called at runtime to update the field with fundraiser specific settings during creation.
 */
function _fundraiser_amount_field_create($fundraiser, $field) {
  // If donation amounts don't exist, use amount as is.
  if (empty($fundraiser->donation_amounts) || !is_array($fundraiser->donation_amounts)) {
    // Show the minimum amount when only displaying an amount text box.
    $field['#extra']['description'] = 'Minimum payment $' . number_format($fundraiser->minimum_donation_amount, 2) . '.';
    return $field;
  }
  // Else we want a select field.
  if (is_array($fundraiser->donation_amounts)) {
    // Since we have an array of donation_amounts, set the field data to match.
    $keys = array_keys($fundraiser->donation_amounts);
    // Construct a set of options based on the configured amounts.
    $formatted_amounts = '';
    foreach ($fundraiser->donation_amounts as $value => $label) {
      if (empty($label)) {
        $label = '$' . $value;
      }
      $formatted_amounts[] = implode('|', array($value, $label));
    }
    if ($fundraiser->show_other_amount && count($fundraiser->donation_amounts)) {
      // Strip out other other|Other combiantions and make sure this is at the end.
      $formatted_amounts = array_diff($formatted_amounts, array('other|Other'));
      $formatted_amounts[] = 'other|Other';
    }
    $formatted_amounts = implode("\n", $formatted_amounts);
    $field['#title'] = t('Please select your tax-deductible gift amount below');
    $field['#type'] = 'select';
    $field['#extra'] = array(
      'description' => '',
      'items' => $formatted_amounts,
      'multiple' => 0,
    );
    $field['#value'] = $keys[0];
  }
  return $field;
}

/**
 * Field callback, called at runtime to update the field with fundraiser specific settings during creation.
 */
function _fundraiser_other_amount_field_create($fundraiser, $field) {
  // If donation amounts don't exist, drop the amount_other field, and use amount as is.
  if (empty($fundraiser->donation_amounts) || !is_array($fundraiser->donation_amounts)) {
    return FALSE; // FALSE as opposed to empty, means we delete this field if it exists.
  }
  // If the show other options is disallowed, unset it.
  if (!$fundraiser->show_other_amount) {
    return FALSE; // FALSE as opposed to empty, means we delete this field if it exists.
  }
  // Update the min with fundraiser's min.
  $field['#extra']['description'] = 'Minimum payment $' . number_format($fundraiser->minimum_donation_amount, 2). '.';
  // Return the field to be created.
  return $field;
}

/**
 * Validation callback for field other_amount. Called during form validation.
 */
function _fundraiser_other_amount_field_validate($form, $form_state, $submission_fields, $value) {
	// Check for confusing selection.
	if (!empty($submission_fields['amount']) && $submission_fields['amount'] != "other" && !empty($submission_fields['other_amount'])) {
    return array(
      'amount' => t('You have entered a custom amount and selected a set amount. Please clarify which amount you ' .
        'intend to give, if you want to give the amount that appears in the other box, please select Other from ' .
        'the radio buttons.'),
      'other_amount' => '',
      );
	}
  $value = $submission_fields['amount'];
  // Look for other amount if set.
  if ($submission_fields['amount'] == 'other') {
    $value = $submission_fields['other_amount'];
  }
  // Check for valid value.
  if (!preg_match('/^\d*(\.\d*)?$/', $value)) {
    return array('other_amount' => t('Donation amount must be in a valid number format. No commas and only one decimal point.'));
  }
  // Check for minimum amount.
  $fundraiser = _fundraiser_get_fundraiser_by_nid($form['#node']->nid);
  $minimum_donation_amount = isset($fundraiser->minimum_donation_amount) ?
    $fundraiser->minimum_donation_amount :  variable_get('fundraiser_default_minimum', 10.00);
  $minimum_donation_amount = number_format($minimum_donation_amount, 2);
  if ($value < $minimum_donation_amount) {
    return array('other_amount' => t('Your donation amount must be greater than or equal to @min_amount.',
      array('@min_amount' => $minimum_donation_amount)));
  }
}

/**
 * Validation callback for field email. Called during form validation.
 */
function _fundraiser_email_field_validate($form, $form_state, $submission_fields,  $value) {
  if (!_fundraiser_validate_email($value)) {
    return array('mail' => t('You must enter a valid email address.'));
  }
}

/**
 * Field callback, called at runtime to update the field with fundraiser specific settings during creation.
 */
function _fundraiser_payment_method_field_create($fundraiser, $field) {
  // If donation amounts don't exist, use amount as is.
  if (empty($fundraiser->gateways)) {
    // Leave it alone, do nothing else, don't overwrite existing values.
    $field['#allow_update'] = 0;
    return $field;
  }
  // Set all the fields for the gateways based on the configuration.
  $field['#extra'] = array(
    'payment_methods' => unserialize($fundraiser->gateways),
  );
  return $field;
}

/**
 * Asks the display glue module(s) for field information.
 * This allows other modules to find a field as needed in a form array.
 * For example - for retrieveing the AJAX return values of a form.
 */
function fundraiser_get_form_field($calling_module, $form, $field_key) {
  // Get the form element from the given form.
  if (module_hook($calling_module, 'fundraiser_get_form_field')) {
    return module_invoke($calling_module, 'fundraiser_get_form_field', $form, $field_key);
  }
  else {
    // Assume the form is a regularly constructed form and find it in a child somewhere.
    return _fundraiser_get_form_field($form, $field_key);
  }
}

/**
 * Asks the display glue module(s) to update field information.
 * This allows other modules to update a field as needed in a form array.
 */
function fundraiser_update_form_field($calling_module, $form, $field_key, $new_field) {
  // Save the changed form element.
  if (module_hook($calling_module, 'fundraiser_update_form_field')) {
    return module_invoke($calling_module, 'fundraiser_update_form_field', $form, $field_key, $new_field);
  }
  else {
    return _fundraiser_update_form_field($form, $field_key, $new_field);
  }
}

/**
 * There is no need for a creation function here to handle creating fields in a hook.
 * That is something the display glue module should be able to handle on it's own
 * given access to the callback information. No reason to put that in the central module.
 */

/**
 * Process through given submission fields to change their display form on the fly. Recursive.
 * Calling module provides the identity of the display glue module. Usually webform, could be sustainers.
 */
function fundraiser_display_form_fields($calling_module, &$form, $form_state, $field_info = NULL) {
  if ($field_info == NULL) {
    $field_info = fundraiser_field_info();
  }
  $children = element_children($field_info);
  foreach ($children as $child) {
    if (isset($field_info[$child]['#display_callback']) && function_exists($field_info[$child]['#display_callback'])) {
      // Get the field, update it, and put it back.
      $this_field = fundraiser_get_form_field($calling_module, $form, $child);
      $new_field = call_user_func($field_info[$child]['#display_callback'], $form, $form_state, $this_field);
      $form = fundraiser_update_form_field($calling_module, $form, $child, $new_field);
    }
    // Check for any further children.
    fundraiser_display_form_fields($calling_module, $form, $form_state, $field_info[$child]);
  }
}

/**
 * Process through given submission fields to validate on the fly. Recursive.
 * This handles the calls to additional validation callbacks as defined in the field_info array.
 * May be called by any module that needs to perform validation on a submitted array. See sustainers.
 */
function fundraiser_validate_form_fields($form, $form_state, $submission_fields, $field_info = NULL, $errors = FALSE) {
  // Grab field info, we'll use this all the way down.
  if ($field_info == NULL) {
    $field_info = fundraiser_field_info();
  }
  // Check for errors by field info array.
  $children = element_children($field_info);
  foreach ($children as $child) {
    $keys[$child] = '';
    // Check only if the submission field is set.
    // And the additional validate callback exists.
    if (isset($submission_fields[$child]) && isset($field_info[$child]['#validate_callback'])
      && function_exists($field_info[$child]['#validate_callback'])) {
      $error_messages = call_user_func($field_info[$child]['#validate_callback'], $form, $form_state,
        $submission_fields, $submission_fields[$child]);
      if (isset($error_messages) && !empty($error_messages)) {
        foreach ($error_messages as $form_field => $error_message) {
          // Set the error.
          $this_field = _fundraiser_get_form_field($form, $form_field);
          $parents = implode('][', $this_field['#parents']);
          form_set_error($parents, $error_message); // Coder: This is ok.
          $errors = TRUE;
        }
      }
    }
    // Recurse down.
    $errors = fundraiser_validate_form_fields($form, $form_state, $submission_fields, $field_info[$child], $errors);
  }
  return $errors;
}

/**
 * Donation form functions.
 */

/**
 * Donation form, display routine on data returned from glue display module.
 * Must be called from glue display module when displaying the donation form.
 */
function fundraiser_donation_form(&$form, &$form_state) {
  // Check to see if the form is being accessed over HTTPS.
  if ((!_fundraiser_is_secure() && !variable_get('fundraiser_development_mode', 0))) {
    // Return a 404 if the page isn't secure and should be.
    $node = $form['#node'];
    watchdog('fundraiser', 'The donation form <em>!title</em> is not protected with SSL.',
      array('!title' => $node->title), WATCHDOG_CRITICAL, l('View the donation form', 'node/' . $node->nid));
    $message = variable_get('fundraiser_http_error_message', t('We\'re sorry. The donation form you are trying ' .
      'to access has not been secured properly. Safeguarding your personal information is extremely important ' .
      'to us, therefore we cannot accept donations from this form at this time.'));
    // Remove all other form elements.
    foreach (element_children($form) as $child) {
      unset($form[$child]);
    }
    // Display the message.
    $form['fundraiser_http_error'] = array(
      '#type' => 'item',
      '#markup' => $message,
    );
  }
  else {
    // Prevent caching on this form, this will keep the back button operational.
    drupal_add_http_header('Cache-Control', 'no-cache, no-store, must-revalidate, post-check=0, pre-check=0');
    // Add validation and submit routines for fundraiser to get called during submission.
    // Otherwise, do nothing, rely on the glue modules to provide the form we need to the user.
    // We add these first to make sure they're available for the hook call.
    $form['#validate'][] = 'fundraiser_donation_validate';
    $form['#submit'][] = 'fundraiser_donation_submit';

    // When confirmations are moved, this goes elsewhere.
    $form['#submit'][] = 'fundraiser_donation_post_submit';

    // Call hook to allow sub modules to add / manipulate the form.
    // NOTE: we are not using module_invoke_all on purpose here.
    // Node objects (common on webform objs) flag as recursive warnings.
    //$form = module_invoke_all('fundraiser_donation_form', $form, $form_state);
    foreach (module_implements('fundraiser_donation_form') as $module) {
      $result = module_invoke($module, 'fundraiser_donation_form', $form, $form_state);
      if (isset($result) && is_array($result)) {
        $form = array_merge($form, $result);
      }
    }
  }
}

/**
 * Donation form, validation routine on data returned from glue display module.
 * Called from glue display module to validate additional data.
 */
function fundraiser_donation_validate(&$form, &$form_state) {
  // Call hook to validate donation values against fundraiser needs and sub module needs.
  // Each is meant to return a not ok response or nothing.
  // No response = we're all good, otherwise we return an array of values for handling.
  $errors = module_invoke_all('fundraiser_donation_validate', $form, $form_state);
  // Then handle our own business.
  if (!empty($errors)) {
    // Call the related donation process function.
    fundraiser_donation_failed_validation($errors);
  }
}

/**
 * Donation form, submission routine on data returned from glue display module.
 * Called from glue display module to submit additional data.
 * NOTE: This is the right function to call repeatedly (with different data as needed)
 * if you need to submit n+ donations on any single submission.
 * Assumption in all of the fundraiser system is that one submission of a form = one donation.
 * So keep that in mind as you work, if you need to make more than one donation at a time
 * then it is better to falsify multiple submissions to the form than to try and shove more than
 * one donation processed per submission.
 */
function fundraiser_donation_submit(&$form, &$form_state) {
  // Create the donation object and load it with the submitted information for the donation.
  $donation = (object) array();
  // Using user load to avoid user object being carried by ref around.
  global $user;
  $donation->uid = $user->uid;
  $donation->user = user_load($user->uid);
  // Load the node from the form.
  $donation->nid = $form['#node']->nid;
  $donation->node = $form['#node'];

  // Call hook to gather submission donation values for the donation.
  module_invoke_all('fundraiser_donation_submit', $form, $form_state, $donation);
  // $donation->donation now contains the submitted values from the form.
  // Once we have a submission we can get to the real meat of things and attempt to create it.
  // This calls our set of functions to process the donation from there.
  if (!empty($donation->donation)) {
    _fundraiser_donation_submit_to_process($form, $form_state, $donation);
    _fundraiser_donation_submit_after_process($donation);
  }
  else {
    // No submission was able to be found. So we really have nothing to go on.
    // Mark this as a failure and move on.
    $donation->result['success'] = FALSE;
  }
  // Add the donation and result info to the form_state so we can reference it later.
  $form_state['#donation'] = $donation;
}

/**
 * Helper function, given a donation object, central function to create, process, and manage results.
 * Provided for other modules to use as needed for redirection style processes.
 */
function _fundraiser_donation_submit_to_process($form, $form_state, $donation) {
  // Create the donation to process, allows other modules to modify results by hooks.
  fundraiser_donation_create($donation);
  $did = $donation->did;
  // Caching form values are provided ONLY for the purpose of handling redirect submissions.
  // It is intended to allow redirects to pick back up with form submission after returning to site.
  cache_set('fundraiser-form-id-' . $did, $form_state['values']['form_build_id'], 'cache', strtotime('+15 minutes'));
  // Cache the CURRENT version of the forms as well, as they have been processed up to this point.
  cache_set('fundraiser-form-' . $did, $form, 'cache_form', strtotime('+15 minutes'));
  cache_set('fundraiser-form-state-' . $did, $form_state, 'cache_form', strtotime('+15 minutes'));
  // The created donation information should be at at $donation->donation, ready to process.
  fundraiser_donation_process($donation);
}

/**
 * Helper function, given a donation object, central function to create, process, and manage results.
 * Provided for other modules to use as needed for redirection style processes.
 */
function _fundraiser_donation_submit_after_process($donation) {
  // Clear caches.
  cache_clear_all('fundraiser-form-id-' . $donation->did, 'cache');
  cache_clear_all('fundraiser-form-' . $donation->did, 'cache_form');
  cache_clear_all('fundraiser-form-state-' . $donation->did, 'cache_form');

  // Finish donation processing.
  if (!isset($donation->result['message'])) {
    $donation->result['message'] = '';
  }
  // The results should be at $donation->result, ready to respond to the aftermath.
  if (isset($donation->result['success']) && $donation->result['success']) {
    fundraiser_donation_success($donation);
  }
  else {
    $donation->result['success'] = FALSE;
    fundraiser_donation_decline($donation);
  }
}

/**
 * Submit callback after donation submitted, but before confirmation.
 */
function fundraiser_donation_post_submit(&$form, &$form_state) {
  // And after all of that is done, provide a hook to allow for sub modules to change behavior after submission.
  // Such as in cases of failures or the like. Return the donation object and result.
  // We return form_state here, because we cannot pass arrays by reference in module calls.
  // See: http://drupal.org/node/353494 for a detailed discussion of this one.
  $form_state = module_invoke_all('fundraiser_donation_post_submit', $form, $form_state, $form_state['#donation']);
}

/**
 * Refund donation form functions.
 */

/**
 * Menu callback for refund tab on donations.
 */
function fundraiser_show_refund_form($did) {
  if (!user_access('refund donations')) {
    drupal_set_message(t('You do not have access to refund donations.'));
    return '';
  }
  drupal_add_css(drupal_get_path('module', 'fundraiser') . '/css/refund.css');
  drupal_add_js(drupal_get_path('module', 'fundraiser') . '/js/refund.js');
  return drupal_render( drupal_get_form('_fundraiser_refund', $did) );
}

/**
 * Refund form
 */
function _fundraiser_refund($form, &$form_state, $did) {
  $form = array();
  // Given a donation ID, grab all relevant information to create the form.
  $donation = fundraiser_donation_get_donation($did);
  $form['#donation'] = $form_state['#donation'] = $donation;
  $form['payment_summary'] = array(
    '#type' => 'fieldset',
    '#title' => t('Payment Summary'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  if (!isset($donation->payment)) {
    $form['payment_summary']['no_payments'] = array(
      '#type' => 'item',
      '#markup' => t('No payments have been made on this order yet.'),
      '#prefix' => '<div>',
      '#suffix' => '</div>',
    );
  }
  else {
    $form['payment_summary']['payment_total'] = array(
      '#type' => 'item',
      '#title' => t('Payment Total'),
      '#markup' => $donation->donation['amount'],
    );
    $form['payment_summary']['refunded_total'] = array(
      '#type' => 'item',
      '#title' => t('Refunded Total'),
      '#markup' => $donation->payment['refunded_total'],
    );
    if (isset($donation->payment['refunded_summary'])) {
      $form['payment_summary']['refunded_summary'] = array(
        '#type' => 'item',
        '#title' => t('Previously Refunded'),
        '#markup' => $donation->payment['refunded_summary'],
      );
    }
  }

  // Form for submitting a refund.
  $form['refund_options'] = array(
    '#type' => 'fieldset',
    '#title' => t('Refund Options'),
    '#description' => t('Note that refunds can only be applied to payments that have been settled in the payment processor. This typically ' .
     'happens every night; if the payment was made today, you will probably need to wait until tomorrow to issue a refund.'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  // Only show the refund form if the payment was made through a payment gateway that can handle refunds
  if (isset($donation->gateway)) {  // Set during fundraiser_donation_get_donation().
    $gateway = $donation->gateway;
    $can_refund = isset($gateway['refund_function']) ? $gateway['refund_function'] : NULL;
    if (!$can_refund || !isset($donation->payment)) {
      // They've made a payment, but it cannot be refunded
      if (isset($donation->payment)) {
        $no_refund_text = t('Refunds cannot be made on this order. The payment was made on a payment gateway that does not support refunds.');
      }
      // They have NOT made any payment yet, so there's nothing to refund
      else {
        $no_refund_text = t('No payments have been processed on this order, so no refunds can be made yet.');
        // Even once the payment is made, they won't be able to refund it
        if (!$can_refund) {
          $no_refund_text .= ' ' . t('However, because this order was made on a payment gateway that does not support refunds, you will not be able to ' .
            'make refunds after payments are processed on this order.');
        }
      }
      $form['refund_options']['no_refund_explanation'] = array(
        '#markup' => $no_refund_text,
        '#prefix' => '<strong>',
        '#suffix' => '</strong>',
      );
    }
    // Provide refund options
    else {
      $able_to_refund = $donation->donation['amount'] - $donation->payment['refunded_total'];
      $form['refund_options']['full_refund'] = array(
        '#type' => 'radio',
        '#title' => t('Full Refund (%amount)', array('%amount' => $able_to_refund)),
        '#return_value' => 'full',
        '#parents' => array('refund_type'),
      );
      $form['refund_options']['partial_refund'] = array(
        '#type' => 'radio',
        '#title' => t('Partial Refund'),
        '#return_value' => 'partial',
        '#parents' => array('refund_type'),
      );
      $form['refund_options']['amount'] = array(
        '#type' => 'textfield',
        '#title' => t('Amount to Refund'),
        '#size' => 40,
        '#maxlength' => 255,
      );
      $form['refund_options']['refund_notes'] = array(
        '#type' => 'textarea',
        '#title' => t('Refund Notes'),
        '#description' => t('Please provide reference information about this refund (Requestor, reason, etc.)'),
        '#cols' => 60,
        '#rows' => 5,
        '#required' => TRUE,
      );
      $form['refund_options']['issue_refund'] = array(
        '#type' => 'submit',
        '#value' => t('Issue Refund'),
        '#required' => TRUE,
      );
      $form['total_paid'] = array(
        '#type' => 'hidden',
        '#value' => number_format($able_to_refund, 2),
      );
    }
  }
  else {
    $form['refund_options']['no_refund_explanation'] = array(
      '#markup' => t('The gateway for this refund is no longer available. A refund cannot be offered on this transaction.'),
      '#prefix' => '<strong>',
      '#suffix' => '</strong>',
    );
  }
  return $form;
}

/**
 * Validate the form
 */
function _fundraiser_refund_validate($form, &$form_state) {
  // Get the donation.
  $donation = $form['#donation'];
  // Make sure they chose a refund type
  if (empty($form_state['values']['refund_type'])) {
    form_set_error('refund_type', t('Choose a refund type.'));
  }
  // If it isn't a full refund, make sure they entered a valid value
  elseif ($form_state['values']['refund_type'] != 'full') {
    $amount = (float) $form_state['values']['amount'];
    if ($amount <= 0) {
      form_set_error('amount', t('Enter a refund amount.'));
    }
    else {
      // Determine how much has been paid, less previous refunds
      $able_to_refund = $donation->donation['amount'] - $donation->payment['refunded_total'];
      if ($amount > $able_to_refund) {
        $context = array(
          'revision' => 'formatted-original',
          'type' => 'amount',
        );
        form_set_error('amount', t('The refund amount entered is too high. Only @paid in payments have been made, and no ' .
          'more than that can be refunded.', array('@paid' => $able_to_refund)));
      }
    }
  }
}

/**
 * Submit the refund form
 */
function _fundraiser_refund_submit($form, &$form_state) {
  // Get the donation.
  $donation = $form['#donation'];
  // Determine how much has been paid, less previous refunds
  $able_to_refund = $donation->donation['amount'] - $donation->payment['refunded_total'];
  // Partial refund
  if ($form_state['values']['refund_type'] != 'full') {
    $new_order_status = 'partially_refunded';
    $amount = (float) $form_state['values']['amount'];
    // Can't refund more than they've paid
    // Use >= so that the status is set properly if they choose Partial Refund.
    if ($amount >= $able_to_refund) {
      $amount = $able_to_refund;
      $new_order_status = 'refunded';
    }
  }
  // Full refund
  else {
    $new_order_status = 'refunded';
    $amount = $able_to_refund;
  }

  // Make the charge amount negative
  $amount = abs($amount) * -1;
  $refund = clone $donation;
  $refund->donation['amount'] = $amount;
  // A refunded donation is simply another donation with a reverse charge on it.
  $refund->refunded_donation_did = $refund->did;
  unset($refund->did);
  $donation->donation['refund_amount'] = $amount;
  $donation->donation['refund_reason'] = $form_state['values']['refund_notes'];
  fundraiser_donation_create($refund);
  // The created donation information should be at at $donation->donation, ready to process.
  fundraiser_donation_refund($refund);
  // At this point $donation->result is set and responses can be handled.
  if (!isset($refund->result['message'])) {
    $refund->result['message'] = '';
  }
  // The results should be at $donation->result, ready to respond to the aftermath.
  if (isset($refund->result['success']) && $refund->result['success'] == TRUE) {
    fundraiser_donation_refund_success($refund);
  }
  else {
    $donation->result['success'] = FALSE;
    drupal_set_message(t('Your refund failed to be processed.'));
    fundraiser_donation_refund_decline($refund);
    $form_state['rebuild'] = TRUE;
    $form_state['values']['abort'] = TRUE;
  }
}

/**
 * Donation processing functions.
 */

/**
 * Donation processing, a given donation needs to be commented on.
 */
function fundraiser_donation_comment($donation, $comment, $variables = array(), $severity = WATCHDOG_NOTICE, $link = NULL) {
  // Make a log entry
  if (variable_get('fundraiser_log_comments', 0)) {
    watchdog('fundraiser_comment', $comment, $variables, $severity, $link);
  }
  // Allow other modules to respond to the cancel. Including Ubercart, etc.
  module_invoke_all('fundraiser_donation_comment', $donation, $comment, $variables, $severity, $link);
}

/**
 * Given a donation id, gather information to display for that donation.
 * To be displayed when needed by other modules.
 */
function fundraiser_donation_information_table($did) {
  $rows = array();
  $donation = fundraiser_donation_get_donation($did);
  $rows[] = array('Fundraiser user', t('#@uid - !name',
    array('@uid' => $donation->uid, '!name' => l($donation->user->name, 'user/' . $donation->user->uid))));
  if (isset($donation->node->nid)) {
    $rows[] = array('Fundraiser node', t('#@nid - !title',
      array('@nid' => $donation->nid, '!title' => l($donation->node->title, 'node/' . $donation->node->nid))));
  }
  else {
    $rows[] = array('Fundraiser node', t('#@nid - !title',
      array('@nid' => '---', '!title' => t('No fundraiser node found.'))));
  }
  $variables = array('header' => array(), 'rows' => $rows);
  drupal_alter('fundraiser_donation_information_table', $variables, $donation);
  return theme('table', $variables);
}

/**
 * Donation processing, a given donation failed to validate.
 */
function fundraiser_donation_failed_validation($errors) {
  // Handle our own tracking.
  _fundraiser_update_tracking_value($errors['nid'], 'local_failures');
  // Call hook to allow sub modules to respond to the failure as well.
  module_invoke_all('fundraiser_donation_failed_validation', $errors);
}

/**
 * Donation processing, a donation needs to be created prior to processing.
 */
function fundraiser_donation_create($donation) {
  // The gateway is selected by the user, was set during submission. Same as nid, uid, sid etc.
  // Call hooks to create the donation. The glue module handles everything else once handed fundraisers info.
  // This is a good location to update $donation->data for processing.
  module_invoke_all('fundraiser_donation_create', $donation);
  // For now, our creation system is responsible for creating a did.
  // Track the did, nid, uid internally so we can keep things in order.
  // Grab the submission path, if there is no alias, use the standard node path.
  global $base_url;
  $alias = drupal_lookup_path('alias', $_GET['q']);
  $form_url = '';
  if (!empty($alias)) {
    $form_url = $base_url . '/' . $alias;
  }
  else {
    $form_url = $base_url . '/node/' . $donation->nid;
  }
  $donation_record = array(
    'did' => $donation->did, // Donation id.
    'nid' => $donation->nid, // Fundraiser node id.
    'uid' => $donation->uid,  // Submission user id.
    'sid' => $donation->sid,  // Submission id.
    'status' => $donation->status,
    'amount' => $donation->donation['amount'],
    'currency' => $donation->donation['currency'],
    'gateway' => $donation->gateway,
    'txn_id' => '',
    'form_url' => $form_url,
    'created' => REQUEST_TIME,
    'changed' => REQUEST_TIME,
  );
  _fundraiser_create_donation($donation_record);
  // Add a comment.
  global $user;
  $username = isset($user->name) ? $user->name : 'Anonymous';
  fundraiser_donation_comment($donation, 'This donation was created on @date by @username.',
    array('@date' => format_date(strtotime('now')), '@username' => $username));
  // Respond after the creation of a donation. (Insert essentially)
  // At this point an order has been created by the charging module and etc.
  module_invoke_all('fundraiser_donation_post_create', $donation);
}

/**
 * Donation processing, a donation needs to be updated with new information prior to processing.
 * For example, in the course of updating a sustainers information.
 */
function fundraiser_donation_update($donation, $vocal_mode = TRUE) {
  // Call hooks to create the donation. The glue module handles everything else once handed fundraisers info.
  module_invoke_all('fundraiser_donation_update', $donation);
  // The additional fields $donation->additional, ready to process.
  // For now, our creation system is responsible for creating a did.
  // Track the did, nid, uid internally so we can keep things in order.
  $fundraiser_node = node_load($donation->nid);
  $donation_record = array('did' => $donation->did);
  if (isset($donation->nid) && !empty($donation->nid)) {
    $donation_record['nid'] = $donation->nid;
  }
  if (isset($donation->uid) && !empty($donation->uid)) {
    $donation_record['uid'] = $donation->uid;
  }
  if (isset($donation->sid) && !empty($donation->sid)) {
    $donation_record['sid'] = $donation->sid;
  }
  if (isset($donation->status) && !empty($donation->status)) {
    $donation_record['status'] = $donation->status;
  }
  if (isset($donation->amount) && !empty($donation->amount)) {
    $donation_record['amount'] = $donation->amount;
  }
  if (isset($donation->currency) && !empty($donation->currency)) {
    $donation_record['currency'] = $donation->currency;
  }
  if (isset($donation->gateway) && !empty($donation->gateway) && is_string($donation->gateway)) {
    $donation_record['gateway'] = $donation->gateway;
  }
  if (isset($donation->txn_id) && !empty($donation->txn_id)) {
    $donation_record['txn_id'] = $donation->txn_id;
  }
  if (isset($donation->form_url) && !empty($donation->form_url)) {
    $donation_record['form_url'] = $donation->form_url;
  }
  $donation_record['changed'] = REQUEST_TIME;
  _fundraiser_update_donation($donation_record);
  // Refresh the cache. No need to change the donation object passed in, but stored values should be zapped.
  fundraiser_donation_get_donation($donation->did, TRUE);
  // Add a comment.
  if ($vocal_mode) {
    global $user;
    $username = isset($user->name) ? $user->name : 'Anonymous';
    fundraiser_donation_comment($donation, 'This donation was updated on @date by @username.',
      array('@date' => format_date(strtotime('now')), '@username' => $username));
  }
  // Respond after the update of a donation.
  module_invoke_all('fundraiser_donation_post_update', $donation);
}

/**
 * Donation processing, a given donation needs to be processed.
 */
function fundraiser_donation_process($donation) {
  // Pass this down to the processing module.
  module_invoke_all('fundraiser_donation_process', $donation);
  // And save the donation as it is at this stage since it was created.
  // This makes sure that any changes made stay in place.
  fundraiser_donation_update($donation, FALSE);
  // Respond after the update of a donation.
  module_invoke_all('fundraiser_donation_post_process', $donation);
}

/**
 * Donation processing, a given donation was successful.
 */
function fundraiser_donation_success($donation) {
  // Track the success.
  _fundraiser_update_tracking_value($donation->nid, 'conversions');
  // Show gateay message if appropriate.
  $display_message = variable_get('fundraiser_gateway_messages', 1);
  if ($display_message) {
    drupal_set_message($donation->result['message']);
  }
  // Allow other modules to respond to the success.
  module_invoke_all('fundraiser_donation_success', $donation);
  // Add a comment.
  global $user;
  $username = isset($user->name) ? $user->name : 'Anonymous';
  fundraiser_donation_comment($donation, 'This donation was successfully completed on @date by @username.',
    array('@date' => format_date(strtotime('now')), '@username' => $username));
  // And save the donation as it is at this stage since it was created.
  // This makes sure that any changes made stay in place.
  fundraiser_donation_update($donation, FALSE);
}

/**
 * Donation processing, a given donation was declined.
 */
function fundraiser_donation_decline($donation) {
  // Track this failure.
  _fundraiser_update_tracking_value($donation->nid, 'gateway_failures');
  // Make a log entry.
  watchdog('fundraiser', 'Donation @id was declined by the payment gateway. Reason: @message',
    array('@id' => $donation->did, '@message' => $donation->result['message']), WATCHDOG_DEBUG, NULL);
  // Show gateay message if appropriate.
  $display_message = variable_get('fundraiser_gateway_messages', 1);
  if ($display_message) {
    drupal_set_message($donation->result['message']);
  }
  // Allow other modules to respond to the decline.
  module_invoke_all('fundraiser_donation_decline', $donation);
  // Add a comment.
  global $user;
  $username = isset($user->name) ? $user->name : 'Anonymous';
  fundraiser_donation_comment($donation, 'This donation was declined at the gateway on @date by @username.',
    array('@date' => format_date(strtotime('now')), '@username' => $username));
  // And save the donation as it is at this stage since it was created.
  // This makes sure that any changes made stay in place.
  fundraiser_donation_update($donation, FALSE);
}

// TODO how does this even get called? Is this functionally different from a decline?
/**
 * Donation processing, a given donation experienced an exception.
 */
function fundraiser_donation_exception($donation) {
  // Make a log entry.
  watchdog('fundraiser', 'An error occurred while processing donation @id. Error: @message',
    array('@id' => $donation->did, '@message' => $donation->result['message']), WATCHDOG_ERROR, NULL);
  // Show gateay message if appropriate.
  $display_message = variable_get('fundraiser_gateway_messages', 1);
  if ($display_message) {
    drupal_set_message($donation->result['message']);
  }
  // Add a comment.
  global $user;
  $username = isset($user->name) ? $user->name : 'Anonymous';
  fundraiser_donation_comment($donation, 'This donation encountered an exception on @date by @username.',
    array('@date' => format_date(strtotime('now')), '@username' => $username));
  // And save the donation as it is at this stage since it was created.
  // This makes sure that any changes made stay in place.
  fundraiser_donation_update($donation, FALSE);
  // Allow other modules to respond to the exception.
  module_invoke_all('fundraiser_donation_exception', $donation);
}

/**
 * Donation processing, a given donation needs to be cancelled.
 * Generally, only available for Authorize.net gteway donations. For example, during sustainer call.
 */
function fundraiser_donation_cancel($donation) {
  // Make a log entry
  watchdog('fundraiser', 'Donation @id was canceled by the user.',
    array('@id' => $donation->did), WATCHDOG_DEBUG, NULL);
  // Show gateay message if appropriate.
  $display_message = variable_get('fundraiser_gateway_messages', 1);
  if ($display_message) {
    drupal_set_message(t('Your payment #:did has been canceled.', array(':did' => $donation->did)));
  }
  // Add a comment.
  global $user;
  $username = isset($user->name) ? $user->name : 'Anonymous';
  fundraiser_donation_comment($donation, 'This donation was cancelled on @date by @username.',
    array('@date' => format_date(strtotime('now')), '@username' => $username));
  // And save the donation as it is at this stage since it was created.
  // This makes sure that any changes made stay in place.
  fundraiser_donation_update($donation, FALSE);
  // Allow other modules to respond to the cancel. Including Ubercart, etc.
  module_invoke_all('fundraiser_donation_cancel', $donation);
}

/**
 * Donation processing, a given donation needs to be deleted.
 * Generally, not called, but it does happen.
 */
function fundraiser_donation_delete($donation) {
  // Make a log entry
  watchdog('fundraiser', 'Donation @id was deleted.',
    array('@id' => $donation->did), WATCHDOG_DEBUG, NULL);
  // Show gateay message if appropriate.
  $display_message = variable_get('fundraiser_gateway_messages', 1);
  if ($display_message) {
    drupal_set_message(t('Your payment #:did has been deleted.', array(':did' => $donation->did)));
  }
  // Add a comment.
  global $user;
  $username = isset($user->name) ? $user->name : 'Anonymous';
  fundraiser_donation_comment($donation, 'This donation was deleted on @date by @username.',
    array('@date' => format_date(strtotime('now')), '@username' => $username));
  // And save the donation as it is at this stage since it was created.
  // This makes sure that any changes made stay in place.
  fundraiser_donation_update($donation, FALSE);
  // Allow other modules to respond to the cancel. Including Ubercart, etc.
  module_invoke_all('fundraiser_donation_delete', $donation);
}

/**
 * Donation processing, a given donation needs to be refunded.
 */
function fundraiser_donation_refund($refund) {
  if (!isset($refund->donation['refund_amount']) || empty($refund->donation['refund_amount'])
    || !is_numeric($refund->donation['refund_amount'])) {
    return; // Not a valid amount to refund.
  }
  // Grab the gateway from the fundraiser configured gateway.
  $info = _fundraiser_gateway_info($refund->gateway['id']);
  // Check for the charge function to be defined.
  $refund_function = isset($info['refund_function']) ? $info['refund_function'] : '';
  if (empty($refund_function)) {
    // We can't find the gateway and we should tell someone about it.
    watchdog('fundraiser', 'Cannot determine the payment gateway for donation @id. Node id of donation form is @nid',
      array('@id' => $refund->did, '@nid' => $refund->nid), WATCHDOG_CRITICAL);
    $result = array('success' => FALSE);
  }
  else {
    module_invoke_all('fundraiser_donation_refund', $refund);
  }
}

/**
 * Donation processing, a given refund was successful.
 */
function fundraiser_donation_refund_success($refund) {
  // Save refund data for fundraiser.
  $record = new stdClass();
  $record->did = $refund->refunded_donation_did;
  $record->receipt_id = $refund->did;
  $record->amount = $refund->donation['refund_amount'];
  $record->txn_id = isset($refund->result['data']['txn_id']) ? $refund->result['data']['txn_id'] : ''; 
  $record->reason = $refund->donation['refund_reason'];
  _fundraiser_create_refund($record);
  $refund->refund = $record;
  drupal_set_message(t('Refund has been issued.'), 'status');
  // Allow other modules to respond to the refund success. Such as SF modules.
  module_invoke_all('fundraiser_donation_refund_success', $refund);
}

/**
 * Donation processing, a given refund was declined.
 */
function fundraiser_donation_refund_decline($refund) {
  watchdog('fundraiser', 'Refund on donation #%did failed gateway validation. Reason: %reason.',
    array('%did' => $refund->refunded_donation_did, '%reason' => $refund->result['message']), WATCHDOG_DEBUG);
  drupal_set_message($refund->result['message']);
  // Allow other modules to respond to the refund decline.
  module_invoke_all('fundraiser_donation_refund_decline', $refund);
}

/**
 * Utility function, given a donation id - get everything that goes with it.
 */
function fundraiser_donation_get_donation($did, $refresh = FALSE) {
  // Pull from cached donation unless we are refreshing the cache.
  static $donations;
  if (!$refresh && isset($donations['did'])) {
    return $donations['did'];
  }
  // If refreshing, or first load, pull all data from database.
  $donation = (object) array();
  $donation->did = $did;
  // Grab basic data from our own systems.
  $donation_record = _fundraiser_get_donation_by_did($did);
  $donation->nid = $donation_record->nid;
  $donation->node = node_load($donation_record->nid);
  $donation->uid = $donation_record->uid;
  $donation->user = user_load($donation_record->uid);
  $donation->sid = $donation_record->sid;
  // Additional fields.
  $donation->status = $donation_record->status;
  $donation->amount = $donation_record->amount;
  $donation->currency = $donation_record->currency;
  $donation->created = $donation_record->created;
  $donation->changed = $donation_record->changed;

  // Grab gateway information and replace it in the node too if found.
  $gateway = _fundraiser_get_donation_gateway($did);
  if (isset($gateway['id'] )) {
    $donation->gateway = $gateway;
  }
  // Grab the transaction id if it exists, add it here.
  $donation->txn_id = isset($donation_record->txn_id) ? $donation_record->txn_id : '';
  $donation->form_url = $donation_record->form_url;

  $refunds = _fundraiser_get_refund_by_did($did);
  $refund_summary = array();
  $refunded_total = 0;
  foreach ($refunds as $refund) {
    // TODO figure out how much has been paid and or refunded and add that here.
    $refund_donation = fundraiser_donation_get_donation($refund->receipt_id);
    $donation->payment['receipts'][] = array('id' => $refund_donation->did, 'date' => $refund_donation->last_changed);
    $refunded_total += abs($refund_donation->donation['amount']);
    $refund_summary[] = t('Refund #%id for $%amount on %date.',
      array('%id' => $refund_donation->did, '%amount' => abs($refund_donation->donation['amount']),
        '%date' => date('m/d/y', $refund_donation->last_changed))); //TODO fix up value display for international.
  }
  $donation->payment['refunded_summary'] = !empty($refund_summary) ? theme('item_list', array('items' => $refund_summary)) : t('No refunds have been made.');
  $donation->payment['refunded_total'] = $refunded_total;

  // Call hooks to re-create the donation info.
  // The glue modules handle everything else once handed fundraisers info.
  module_invoke_all('fundraiser_donation_get_donation', $donation);
  // Store the donation information into the cache.
  $donations[$did] = $donation;
  return $donation;
}

/**
 * Fundraiser's own get/set functions for handling fields in forms.
 */

/**
 * Given a standard (non webform, nothing fancy, form array. Locate a given key and return it.
 * Recursive.
 */
function _fundraiser_get_form_field($form, $field_key) {
  // Walks a given form looking for the given key. Returns it when found.
  foreach (element_children($form) as $child) {
    if ($child == $field_key) {
      // Return the found array.
      return $form[$child];
    }
    else {
      // Check this child for other children.
      $found = _fundraiser_get_form_field($form[$child], $field_key);
      if (!empty($found)) {
        return $found;
      }
    }
  }
}

/**
 * Given a standard (non webform, nothing fancy, form array. Locate a given key and update it.
 * Recursive.
 */
function _fundraiser_update_form_field($form, $field_key, $new_field) {
  // Walks a given form looking for the given key. Returns it when found.
  foreach (element_children($form) as $child) {
    if ($child == $field_key) {
      // Update the array.
      $form[$child] = array_merge($form[$child], $new_field);
    }
    else {
      // Check this child for other children.
      $form[$child] = _fundraiser_update_form_field($form[$child], $field_key, $new_field);
    }
  }
  return $form;
}

/**
 * Helper functions.
 */

/**
 * Helper function, given the array from field_info - get the listed keys.
 * WARNING: Recursion is here to walk the field info array to gather form keys.
 */
function _fundraiser_get_field_keys($field_info = NULL, $keys = array()) {
  if ($field_info == NULL) {
    $field_info = fundraiser_field_info();
  }
  $children = element_children($field_info);
  $keys = array_merge($keys, $children);
  foreach ($children as $child) {
    if ($field_info[$child] != NULL && !empty($field_info[$child])) {
      $keys = _fundraiser_get_field_keys($field_info[$child], $keys);
    }
  }
  return $keys;
}

/**
 * Helper function, given the array from field_info - get the listed fields.
 * WARNING: Recursion is here to walk the field info array to gather fields.
 */
function _fundraiser_get_field_fields($field_info = NULL, $fields = array()) {
  if ($field_info == NULL) {
    $field_info = fundraiser_field_info();
  }
  $children = element_children($field_info);
  foreach ($children as $child) {
    $fields[$child] = $field_info[$child];
  }
  foreach ($children as $child) {
    if ($field_info[$child] != NULL && !empty($field_info[$child])) {
      $fields = _fundraiser_get_field_fields($field_info[$child], $fields);
    }
  }
  return $fields;
}

/**
 * Helper function, collects gateway information by calling hook_fundraiser_gateway_info.
 */
function _fundraiser_gateway_info($id = NULL) {
  static $gateways;
  // Cache the gateway during page execution.
  if (empty($gateways)) {
    // If not, we go asking anyone else - usually the payment glue module.
    $gateways = module_invoke_all('fundraiser_gateway_info');
    drupal_alter('fundraiser_gateway_info', $gateways);
  }
  // Look up the gateway needed.
  if ($id != NULL) {
    foreach ($gateways as $delta => $gateway) {
      if ($gateway['id'] == $id) {
        return $gateway;
      }
    }
    return array();
  }
  return (array) $gateways;
}

/**
 * Helper function, determine if this node type supports donation forms.
 */
function fundraiser_is_donation_type($type) {
  static $fundraiser_types;
  // Cache fundraiser content types during page execution.
  if (!isset($fundraiser_types[$type])) {
    $fundraiser_types[$type] = variable_get('fundraiser_' . $type, FALSE);
  }
  return $fundraiser_types[$type];
}

/**
 * Helper function, determine if this node type supports donation forms.
 */
function fundraiser_get_donation_types() {
  // For all types, check if they are a fundraiser type.
  $types = node_type_get_types();
  foreach ($types as $type => $type_info) {
    $fundraiser_types[$type] = variable_get('fundraiser_' . $type, FALSE);
  }
  return $fundraiser_types;
}

/**
 * Helper function. Check if the current page is SSL protected.
 */
function _fundraiser_is_secure() {
  return (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') ? TRUE : FALSE;
}

/**
 * Generic helper functions. These may need to go into a diff. module.
 */

/**
 * Helper function, check if given string is an email format. Generically useful function.
 * Future plans: this may need to be moved to a toolkit module for use by all our modules.
 */
function _fundraiser_validate_email($mail) {
  // eregi is depr in PHP 5.3. Replaced with preg_match, adding lower case options.
  return preg_match("/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}$/", $mail);
}

/**
 * DB functions.
 */

/**
 * CRUD style DB function for fundraiser.
 */
function _fundraiser_create_fundraiser($fundraiser) {
  $fundraiser = (array) $fundraiser;
  $fundraiser_data = FALSE;
  if (isset($fundraiser['nid'])) {
    $fundraiser_data = _fundraiser_get_fundraiser_by_nid($fundraiser['nid']);
  }
  if (!$fundraiser_data) {
    // Implode donation amounds for saving.
    $imploded_amounts = array();
    foreach ($fundraiser['donation_amounts'] as $donation_amount) {
      $imploded_amounts[] = implode('|', $donation_amount);
    }
    $imploded_amounts = array_unique($imploded_amounts);
    // On getting fundraiser this will be exploded into the correct values.
    $fundraiser['donation_amounts'] = implode(',', $imploded_amounts);
    // Serialize for storage, our configured gateway values for storage in components.
    $fundraiser['gateways'] = isset($fundraiser['gateways']) ? serialize($fundraiser['gateways']) : serialize('');
    // After the node is created, add additional data to fundraiser.
    $record = array(
      'receipt_email_from' => variable_get('site_name', ''),
      'receipt_email_address' => variable_get('site_mail', ''),
      'receipt_email_subject' => t('Thank you for your donation'),
      'redirect_url' => '<confirmation>',
    );
    $record = array_merge($record, $fundraiser);
    drupal_write_record('fundraiser', $record);
    // And invoke the hooks for all the other modules to respond.
    module_invoke_all('fundraiser_create_fundraiser_alter', (object) $fundraiser);
  }
  else {
    _fundraiser_update_fundraiser($fundraiser);
  }
}

/**
 * CRUD style DB function for fundraiser.
 */
function _fundraiser_get_fundraiser_by_nid($nid) {
  // Get fundraiser table information.
  $fundraiser = db_query('SELECT * FROM {fundraiser} WHERE nid = :nid', array(':nid' => $nid))->fetchObject();
  if ($fundraiser) {
    // Explode the donation amounts that were imploded during save.
    $donation_amounts = explode(',', $fundraiser->donation_amounts);
    $donation_amounts = array_unique($donation_amounts);
    $exploded_amounts = array();
    foreach ($donation_amounts as $donation_amount) {
      $exploded_amounts[] = explode('|', $donation_amount);
    }
    $fundraiser->donation_amounts = $exploded_amounts;
    // Get the unserialized gateway configurations.
    $fundraiser->gateways = unserialize($fundraiser->gateways);
    // Get values from other modules for additional information.
    module_invoke_all('fundraiser_get_fundraiser_alter', $fundraiser);
  }
  return $fundraiser;
}

/**
 * CRUD style DB function for fundraiser.
 */
function _fundraiser_update_fundraiser($fundraiser) {
  $fundraiser = (array) $fundraiser;
  $fundraiser_data = FALSE;
  if (isset($fundraiser['nid'])) {
    $fundraiser_data = _fundraiser_get_fundraiser_by_nid($fundraiser['nid']);
  }
  if (!$fundraiser_data) {
    _fundraiser_create_fundraiser($fundraiser);
  }
  else {
    $fundraiser = array_merge((array) $fundraiser_data, $fundraiser);
    // Implode donation amounds for saving.
    $imploded_amounts = array();
    foreach ($fundraiser['donation_amounts'] as $donation_amount) {
      $imploded_amounts[] = implode('|', $donation_amount);
    }
    $imploded_amounts = array_unique($imploded_amounts);
    // On getting fundraiser this will be exploded into the correct values.
    $fundraiser['donation_amounts'] = implode(',', $imploded_amounts);
    // Serialize for storage, our configured gateway values for storage in components.
    $fundraiser['gateways'] = serialize($fundraiser['gateways']);
    $record = $fundraiser;
    drupal_write_record('fundraiser', $record, 'nid');
    // And invoke the hooks for all the other modules to respond.
    module_invoke_all('fundraiser_update_fundraiser_alter', (object) $fundraiser);
    // Fire a hook that other modules can use to add additional processing when a donation form is created.
    // Called in: fundraiser_multi_currency.module, sf_donation.module
    // This can, and should, be replaced with hook_node_insert() implementations.
    // THIS HOOK IS TO BE DEPR.
    // module_invoke_all('fundraiser_form_insert', $node, $components);
  }
}

/**
 * CRUD style DB function for fundraiser.
 */
function _fundraiser_delete_fundraiser($nid) {
  db_delete('fundraiser')->condition('nid', $nid)->execute();
  // And invoke the hooks for all the other modules to respond.
  module_invoke_all('fundraiser_delete_fundraiser_alter', $nid);
}

/**
 * DB function for fundraiser.
 */
function _fundraiser_get_fundraiser_by_nids($nids) {
  // Get fundraiser table information.
  $fundraisers = array();
  foreach ($nids as $nid) {
    $fundraisers[$nid] = _fundraiser_get_fundraiser_by_nid($nid);
  }
  return $fundraisers;
}

/**
 * DB function for fundraiser.
 */
function _fundraiser_delete_fundraisers($nodes) {
  foreach ($nodes as $node) {
    _fundraiser_delete_fundraiser($node->nid);
  }
}

/**
 * CRUD style DB function for fundraiser_donation.
 */
function _fundraiser_create_donation($donation) {
  // Cast donation just in case.
  $donation = (array) $donation;
  // Check for old data.
  $donation_data = FALSE;
  if (isset($donation['did'])) {
    $donation_data = _fundraiser_get_donation_by_did($donation['did']);
  }
  if (!$donation_data) {
    $record = array_merge((array) $donation_data, $donation);
    drupal_write_record('fundraiser_donation', $record);
  }
  else {
    _fundraiser_update_donation($donation);
  }
}

/**
 * CRUD style DB function for fundraiser_donation.
 */
function _fundraiser_get_donation_by_did($did) {
  return db_query('SELECT * FROM {fundraiser_donation} ' .
    'WHERE did = :did',
    array(':did' => $did))->fetchObject();
}

/**
 * DB function for fundraiser_donation.
 */
function _fundraiser_get_donations() {
  return db_query('SELECT * FROM {fundraiser_donation}')->fetchAll();
}

/**
 * CRUD style DB function for fundraiser_donation.
 */
function _fundraiser_update_donation($donation) {
  // Cast donation just in case.
  $donation = (array) $donation;
  // Check for old data.
  $donation_data = FALSE;
  if (isset($donation['did'])) {
    $donation_data = _fundraiser_get_donation_by_did($donation['did']);
  }
  if (!$donation_data) {
    _fundraiser_create_donation($donation);
  }
  else {
    $record = array_merge((array) $donation_data, $donation);
    drupal_write_record('fundraiser_donation', $record, 'did');
  }
}

/**
 * CRUD style DB function for fundraiser_donation.
 */
function _fundraiser_delete_donation($did) {
  db_delete('fundraiser_donation')->condition('did', $did)->execute();
}

/**
 * CRUD style DB function for fundraiser_refund.
 */
function _fundraiser_create_refund($refund) {
  // Cast donation just in case.
  $refund = (array) $refund;
  // Check for old data.
  $refund_data = FALSE;
  if (isset($refund['refund_id'])) {
    $refund_data = _fundraiser_get_refund_by_rid($refund['refund_id']);
  }
  if (!$refund_data) {
    $record = $refund;
    drupal_write_record('fundraiser_refund', $record);
  }
  else {
    _fundraiser_update_refund($refund);
  }
}

/**
 * CRUD style DB function for fundraiser_refund.
 */
function _fundraiser_get_refund_by_rid($rid) {
  return db_query('SELECT * FROM {fundraiser_refund} ' .
    'WHERE refund_id = :rid',
    array(':rid' => $rid))->fetchObject();
}

/**
 * CRUD style DB function for fundraiser_refund.
 */
function _fundraiser_update_refund($refund) {
  // Cast donation just in case.
  $refund = (array) $refund;
  // Check for old data.
  $refund_data = FALSE;
  if (isset($refund['refund_id'])) {
    $refund_data = _fundraiser_get_refund_by_rid($refund['refund_id']);
  }
  if (!$refund_data) {
    _fundraiser_create_refund($refund);
  }
  else {
    $record = array_merge((array) $refund_data, $refund); // Merge data together so we get everything in the record.
    drupal_write_record('fundraiser_refund', $refund, 'refund_id');
  }
}

/**
 * CRUD style DB function for fundraiser_refund.
 */
function _fundraiser_delete_refund($rid) {
  db_delete('fundraiser_refund')->condition('refund_id', $rid)->execute();
}

/**
 * DB function for fundraiser_refund.
 */
function _fundraiser_get_refund_by_did($did) {
  return db_query('SELECT * FROM {fundraiser_refund} ' .
    'WHERE did = :did',
    array(':did' => $did))->fetchAll();
}

/**
 * DB Function, Check if the given order was made on a payment gateway that supports refunds
 */
function _fundraiser_get_donation_gateway($did) {
  // First check the donation table. It trumps the fundraiser table in case the FR has changed since.
  $found_gateway = db_query('SELECT d.gateway FROM {fundraiser_donation} d ' .
    'WHERE d.did = :did', array(':did' => $did))->fetchField();
  // Now ask if any other module wants to override this result.
  module_invoke('fundraiser_get_donation_gateway_alter', $did, $found_gateway);
  // Now translate that into something we can use by getting the rest of the dateway info.
  if (isset($found_gateway)) {
    return _fundraiser_gateway_info($found_gateway);
  }
  // If nothing has been found, return nothing.
  return array();
}

/**
 * CRUD style DB function for fundraiser_tracking.
 */
function _fundraiser_create_tracking($tracking) {
  $tracking = (array) $tracking;
  $tracking_data = FALSE;
  if (isset($tracking['nid'])) {
    $tracking_data = _fundraiser_get_tracking_by_nid($tracking['nid']);
  }
  if (!$tracking_data) {
    $record = array(
      'pageviews' => 1,
      'conversions' => 0,
      'local_failures' => 0,
      'gateway_failures' => 0,
      'latest_load_time' => 0,
    );
    $record = array_merge($record, $tracking);
    drupal_write_record('fundraiser_tracking', $record);
  }
  else {
    _fundraiser_update_tracking($tracking);
  }
}

/**
 * CRUD style DB function for fundraiser_tracking.
 */
function _fundraiser_get_tracking_by_nid($nid) {
  return db_query('SELECT * FROM {fundraiser_tracking} WHERE nid = :nid', array(':nid' => $nid))->fetchObject();
}

/**
 * CRUD style DB function for fundraiser_tracking.
 */
function _fundraiser_update_tracking($tracking) {
  $tracking = (array) $tracking;
  $tracking_data = FALSE;
  if (isset($tracking['nid'])) {
    $tracking_data = _fundraiser_get_tracking_by_nid($tracking['nid']);
  }
  if (!$tracking_data) {
    _fundraiser_create_tracking($tracking);
  }
  else {
    $tracking = array_merge((array) $tracking_data, $tracking);
    drupal_write_record('fundraiser_tracking', $tracking, 'nid');
  }
}

/**
 * CRUD style DB function for fundraiser_tracking.
 */
function _fundraiser_delete_tracking($nid) {
  db_delete('fundraiser_tracking')->condition('nid', $nid)->execute();
}

/**
 * DB function for updating the stats in fundraiser_tracking.
 */
function _fundraiser_update_tracking_value($nid, $field) {
  $tracking = _fundraiser_get_tracking_by_nid($nid);
  // No tracking data? Create one.
  if (!$tracking) {
    $tracking->nid = $nid;
    _fundraiser_create_tracking($tracking);
    $tracking = _fundraiser_get_tracking_by_nid($nid);
  }
  // Check to make sure we weren't handed a non-existing track.
  if (isset($tracking->$field)) {
    $tracking->$field++;
    _fundraiser_update_tracking($tracking);
  }
}

/**
 * Implements hook_webform_token_selector_blacklist_alter().
 *
 * Filter out credit card webform components.
 * Note: this replaces _fundraiser_field_blacklist().
 */
function fundraiser_webform_token_selector_blacklist_alter(&$tokens) {
  // These fields may or may not even have a value depending on the user's selected form of submission.
  // So this may not be a viable solution anymore.
  $fundraiser_blacklist = array(
    'card_number',
    'card_cvv',
    'recurs_monthly',
    'card_expiration_month',
    'card_expiration_year',
  );
  $tokens = array_merge($fundraiser_blacklist, $tokens);
}

/**
 * ecommerce-agnostic lookup of total dollar amount donated via a single
 * donation form.
 *
 * @param type $nid
 * Node ID
 *
 * @return total successful donations or FALSE if none found.
 */
function fundraiser_get_total_donations_by_nid($nid, $start = FALSE, $end = FALSE) {
  $node = node_load($nid);
  $total_donations = module_invoke_all('fundraiser_get_total_donations_by_nid', $nid, $start, $end);
  return $total_donations[0];
}

