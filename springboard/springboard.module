<?php

/**
 * @file
 * Provides a admin facing interface to the Springboard system.
 */

/**
 * Implements hook_permission().
 */
function springboard_permission() {
  return array(
    'administer springboard' => array(
      'title' => t('Administer Springboard'),
      'description' => t('Perform administration tasks for springboard.'),
    ),
    'access springboard dashboard' => array(
      'title' => t('Access the Springboard dashboard'),
      'description' => t('Access the main landing page for springboard.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function springboard_menu() {
  $items = array();

  // Springboard task list.
  $items['admin/springboard'] = array(
    'title' => 'Springboard',
    'description' => 'Configure and administer Springboard.',
    'page callback' => 'system_admin_menu_block_page',
    'module' => 'system',
    'file path' => drupal_get_path('module', 'system'),
    'file' => 'system.admin.inc',
    'access arguments' => array('administer springboard'),
    'type' => MENU_NORMAL_ITEM,
  );

  // Springboard dashboard.
  $items['admin/springboard/dashboard'] = array(
    'title' => 'Dashboard',
    'description' => 'Access reports and site maintenance tasks.',
    'access arguments' => array('access springboard dashboard'),
    'page callback' => 'springboard_admin_dashboard',
    'type' => MENU_LOCAL_TASK,
    'weight' => -5,
  );
  // Springboard forms admin.
  $items['admin/springboard/forms'] = array(
    'title' => 'Forms',
    'description' => 'Create, edit and analyze Springboard forms.',
    'page callback' => 'system_admin_menu_block_page',
    'module' => 'system',
    'file path' => drupal_get_path('module', 'system'),
    'file' => 'system.admin.inc',
    'access arguments' => array('administer springboard'),
    'type' => MENU_NORMAL_ITEM,
    'weight' => -4,
  );
  // Springboard reports admin.
  $items['admin/springboard/reports'] = array(
    'title' => 'Reports',
    'description' => 'View Springboard-related reports.',
    'page callback' => 'system_admin_menu_block_page',
    'module' => 'system',
    'file path' => drupal_get_path('module', 'system'),
    'file' => 'system.admin.inc',
    'access arguments' => array('administer springboard'),
    'type' => MENU_NORMAL_ITEM,
    'weight' => -3,
  );
  // Springboard settings list.
  $items['admin/springboard/settings'] = array(
    'title' => 'Settings',
    'description' => 'Configure Springboard modules.',
    'page callback' => 'system_admin_menu_block_page',
    'module' => 'system',
    'file path' => drupal_get_path('module', 'system'),
    'file' => 'system.admin.inc',
    'access arguments' => array('administer springboard'),
    'type' => MENU_LOCAL_TASK,
    'weight' => -2,
  );
  // Springboard dashboard settings.
  $items['admin/springboard/settings/springboard'] = array(
    'title' => 'Springboard',
    'description' => 'Configure Springboard.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('springboard_admin_settings'),
    'access arguments' => array('administer springboard'),
    'file' => 'springboard.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 7
  );
  // Springboard Help
  $items['admin/springboard/help'] = array(
    'title' => 'Help',
    'description' => 'Get help using Springboard.',
    'page callback' => 'springboard_help_page',
    'access arguments' => array('administer springboard'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 99,
  );

  return $items;
}

/**
 * Implements hook_menu().
 * Build Springboard admin menu from existing modules' paths.
 */
function springboard_menu_alter(&$items) {
  // Load Views' paths for later reference.
  $views_paths = array();
  views_menu_alter($views_paths);

  // Add menu items from dsr.
  if (module_exists('dsr')) {
    // DSR reports
    $items['admin/springboard/reports/dsr'] = $items['admin/reports/dsr'];
    $items['admin/springboard/reports/dsr']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/reports/dsr']['access arguments'] = array('administer springboard');
    $items['admin/springboard/reports/dsr']['title'] = 'Reconcilliation report';
    $items['admin/springboard/reports/dsr']['weight'] = 5;

    // DSR settings
    $items['admin/springboard/settings/dsr'] = $items['admin/config/system/dsr'];
    $items['admin/springboard/settings/dsr']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/dsr']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/dsr']['title'] = 'Reconciliation';
    $items['admin/springboard/settings/dsr']['weight'] = 10;
  }

  // Add menu items from email_wrappers.
  if (module_exists('email_wrappers')) {
    // Email Wrappers settings
    $items['admin/springboard/settings/email-wrappers'] = $items['admin/config/system/email-wrappers'];
    $items['admin/springboard/settings/email-wrappers']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/email-wrappers']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/email-wrappers']['title'] = 'Email Confirmations';
    $items['admin/springboard/settings/email-wrappers']['weight'] = 11;
  }

  // Add menu items from fundraiser.
  $types_added = array();
  if (module_exists('fundraiser')) {
    //dynamically generate links to create fundraiser forms
    $types = fundraiser_get_donation_types();
    foreach ($types as $type => $status) {
      if (isset($status) && $status == 1) {
        $types_added[] = $type;
        $type = str_replace('_', '-', $type);
        $items['admin/springboard/forms/create-' . $type] = $items['node/add/' . $type];
        $items['admin/springboard/forms/create-' . $type]['type'] = MENU_NORMAL_ITEM;
        $items['admin/springboard/forms/create-' . $type]['access arguments'] = array('administer springboard');
        $items['admin/springboard/forms/create-' . $type]['title'] = 'Add ' . $items['node/add/' . $type]['title'];
        unset($items['admin/springboard/forms/create-' . $type]['access callback']);
      }
    }

    // View Donation forms
    if (isset($views_paths['admin/content/donation-forms'])) {
      $items['admin/springboard/forms/donations'] = $views_paths['admin/content/donation-forms'];
      $items['admin/springboard/forms/donations']['type'] = MENU_NORMAL_ITEM;
      $items['admin/springboard/forms/donations']['access arguments'] = array('administer springboard');
      $items['admin/springboard/forms/donations']['title'] = 'View Donation Forms';
      $items['admin/springboard/forms/donations']['weight'] = 4;
      unset($items['admin/springboard/forms/donations']['access callback']);
    }

    // Fundraiser settings
    $items['admin/springboard/settings/fundraiser'] = $items['admin/config/system/fundraiser'];
    $items['admin/springboard/settings/fundraiser']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/fundraiser']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/fundraiser']['title'] = 'Fundraiser';
    $items['admin/springboard/settings/fundraiser']['weight'] = 3;
  }

  // Add menu items for fundraiser_sustainers
  if (module_exists('fundraiser_sustainers')) {
    // Fundraiser cron
    $items['admin/springboard/fundraiser_cron'] = array(
      'title' => 'Fundraiser Cron',
      'description' => 'Run the Fundraiser cron.',
      'page callback' => 'fundraiser_sustainers_standalone_cron',
      'module' => 'fundraiser_sustainers',
      'file path' => drupal_get_path('module', 'fundraiser_sustainers'),
      'file' => 'fundraiser_sustainers.module',
      'access arguments' => array('administer springboard'),
      'type' => MENU_NORMAL_ITEM,
      'weight' => 98,
    );
  }

  // Add menu items from market_source.
  if (module_exists('market_source')) {
    $items['admin/springboard/settings/market-source'] = $items['admin/config/search/market-source'];
    $items['admin/springboard/settings/market-source']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/market-source']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/market-source']['weight'] = 2;
  }

  // Add menu items from page_wrappers.
  if (module_exists('page_wrappers')) {
    $items['admin/springboard/settings/page-wrappers'] = $items['admin/config/content/page-wrappers'];
    $items['admin/springboard/settings/page-wrappers']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/page-wrappers']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/page-wrappers']['title'] = 'Page Wrappers';
    $items['admin/springboard/settings/page-wrappers']['weight'] = 4;
  }

  // Add menu items from Salesforce.
  if (module_exists('salesforce')) {
    $items['admin/springboard/settings/salesforce'] = $items['admin/config/salesforce/authorize'];
    $items['admin/springboard/settings/salesforce']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/salesforce']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/salesforce']['title'] = 'Salesforce Admin';
    $items['admin/springboard/settings/salesforce']['weight'] = 8;
  }

  // Add menu items from salesforce_donation.
  if (module_exists('salesforce_donation')) {
    $items['admin/springboard/settings/salesforce-donation'] = $items['admin/config/salesforce/salesforce-donation'];
    $items['admin/springboard/settings/salesforce-donation']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/salesforce-donation']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/salesforce-donation']['title'] = 'Donation';
    $items['admin/springboard/settings/salesforce-donation']['weight'] = 9;
  }

  // Add menu items from salesforce_log.
  if (module_exists('salesforce_log')) {

      // Salesforce batch history
      if (isset($views_paths['admin/reports/salesforce/batch'])) {
        $items['admin/springboard/reports/history'] = $views_paths['admin/reports/salesforce/batch'];
        $items['admin/springboard/reports/history']['type'] = MENU_NORMAL_ITEM;
        $items['admin/springboard/reports/history']['title'] = 'Batch History Report';
        $items['admin/springboard/reports/history']['access arguments'] = array('administer springboard');
        $items['admin/springboard/reports/history']['weight'] = 1;
        unset($items['admin/springboard/reports/history']['access callback']);
      }

      // Salesforce queues
      if (isset($views_paths['admin/reports/salesforce/queue'])) {
        // Salesforce current queue
        $items['admin/springboard/reports/queue'] = $views_paths['admin/reports/salesforce/queue'];
        $items['admin/springboard/reports/queue']['type'] = MENU_NORMAL_ITEM;
        $items['admin/springboard/reports/queue']['title'] = 'Currently Queued Items';
        $items['admin/springboard/reports/queue']['access arguments'] = array('administer springboard');
        $items['admin/springboard/reports/queue']['options'] = array('query' => array('queue' => 'new'));
        $items['admin/springboard/reports/queue']['weight'] = 2;
        unset($items['admin/springboard/reports/queue']['access callback']);

        // Salesforce retry queue
        $items['admin/springboard/reports/queue-retry'] = $items['admin/springboard/reports/queue'];
        $items['admin/springboard/reports/queue-retry']['title'] = 'Retry Queue';
        $items['admin/springboard/reports/queue-retry']['options'] = array('query' => array('queue' => 'retry'));
        $items['admin/springboard/reports/queue-retry']['weight'] = 3;

        // Salesforce permanent failures queue
        $items['admin/springboard/reports/queue-fail'] = $items['admin/springboard/reports/queue'];
        $items['admin/springboard/reports/queue-fail']['title'] = 'Permanent Failure Queue';
        $items['admin/springboard/reports/queue-fail']['options'] = array('query' => array('queue' => 'fail'));
        $items['admin/springboard/reports/queue-fail']['weight'] = 4;
      }
  }

  // Add menu items from salesforce_mapping.
  if (module_exists('salesforce_mapping')) {
    $items['admin/springboard/settings/mappings'] = $items['admin/structure/salesforce/mappings'];
    $items['admin/springboard/settings/mappings']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/mappings']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/mappings']['title'] = 'Salesforce Fieldmaps';
    $items['admin/springboard/settings/mappings']['weight'] = 1;
    unset($items['admin/springboard/settings/mappings']['access callback']);
  }

  // Add menu items from secure_prepopulate.
  if (module_exists('secure_prepopulate')) {
    $items['admin/springboard/settings/secure-prepopulate'] = $items['admin/config/system/secure-prepopulate'];
    $items['admin/springboard/settings/secure-prepopulate']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/secure-prepopulate']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/secure-prepopulate']['weight'] = 5;
  }

  // Add menu items from webform.
  if (module_exists('webform')) {
    //dynamically generate links to create non-fundraiser forms
    $types = webform_variable_get('webform_node_types');
    foreach ($types as $type) {
      if (!in_array($type, $types_added) && isset($items['node/add/' . $type])) {
        $type = str_replace('_', '-', $type);
        $items['admin/springboard/forms/create-' . $type] = $items['node/add/' . $type];
        $items['admin/springboard/forms/create-' . $type]['type'] = MENU_NORMAL_ITEM;
        $items['admin/springboard/forms/create-' . $type]['access arguments'] = array('administer springboard');
        $items['admin/springboard/forms/create-' . $type]['title'] = 'Add ' . $items['node/add/' . $type]['title'];
        unset($items['admin/springboard/forms/create-' . $type]['access callback']);
      }
    }

    // Administer webform content
    $items['admin/springboard/forms/webforms'] = $items['admin/content/webform'];
    $items['admin/springboard/forms/webforms']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/forms/webforms']['access arguments'] = array('administer springboard');
    $items['admin/springboard/forms/webforms']['title'] = 'View ' . $items['admin/content/webform']['title'];
    $items['admin/springboard/forms/webforms']['weight'] = 100;
    unset($items['admin/springboard/forms/webforms']['access callback']);

    // Webform settings
    $items['admin/springboard/settings/webform'] = $items['admin/config/content/webform'];
    $items['admin/springboard/settings/webform']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/webform']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/webform']['title'] = 'Webform';
    $items['admin/springboard/settings/webform']['weight'] = 6;
    unset($items['admin/springboard/settings/webform']['access callback']);
  }

  // Add menu items from webform_dupe_cop.
  if (module_exists('webform_dupe_cop')) {
    $items['admin/springboard/settings/webform-dupe'] = $items['admin/config/content/webform-dupe-cop'];
    $items['admin/springboard/settings/webform-dupe']['type'] = MENU_NORMAL_ITEM;
    $items['admin/springboard/settings/webform-dupe']['access arguments'] = array('administer springboard');
    $items['admin/springboard/settings/webform-dupe']['title'] = 'Webform Dupe';
    $items['admin/springboard/settings/webform-dupe']['weight'] = 12;
  }

}

/**
 * Implements hook_theme().
 */
function springboard_theme($existing, $type, $theme, $path) {
  return array(
    'springboard_sf_status' => array(
      'variables' => array('status' => '', 'identity' => array(), 'batch_status' => '', 'queue' => ''),
      'template' => drupal_get_path('theme', $theme) . '/templates/springboard-sf-status',
    ),
    'springboard_help' => array(
      'variables' => array('help_array' => array()),
      'template' => drupal_get_path('theme', $theme) . '/templates/springboard-help',
    ),
  );
}

/**
 * Menu callback. Springboard dashboard page.
 */
function springboard_admin_dashboard() {
  // Add our CSS for display.
  drupal_add_css(drupal_get_path('module', 'springboard') . '/css/springboard.css', 'module');
  $content = '<div class="springboard-dashboard dashboard">';
  // Load the enabled panes for the dashboard.
  $panes = module_invoke_all('springboard_dashboard_panes');
  drupal_alter('springboard_dashboard_panes', $panes);
  $enabled_panes = variable_get('springboard_enabled_panes', array());
  foreach ($panes as $pane_key => $pane) {
    if (!empty($pane['content']) && !empty($enabled_panes[$pane_key])) {
      $content .= $pane['content'];
    }
  }
  $content .= '</div>';
  return $content;
}

/**
 * Menu callback. Springboard help.
 */
function springboard_help_page() {
  $help_array = module_invoke_all('springboard_help');
  drupal_alter('springboard_help', $help_array);
  return theme('springboard_help', array('help_array' => $help_array));
}

/**
 * Implements hook_springboard_help().
 */
function springboard_springboard_help() {
  $help_array = array();
  $help_array[t('Documentation')] = array(
    t('Springboard documentation is available on !docs.',
      array('!docs' => l('gospringboard.com', 'http://www.gospringboard.com/documentation')))
  );
  $help_array[t('Issue Tracker')] = array(
    t('The Springboard project issue tracker is hosted on !issue_tracker',
      array('!issue_tracker' => l('drupal.org', 'http://drupal.org/project/springboard')))
  );
  return $help_array;
}

/**
 * Implements hook_springboard_dashboard_panes().
 */
function springboard_springboard_dashboard_panes() {
  $panes['springboard_sf_status'] = array(
    'label' => t('Salesforce connection status'),
    'description' => t('Salesforce connection status'),
    'content' => _springboard_sf_status(),
    'weight' => 0,
  );
  global $base_url;
  $panes['springboard_recent_donation_forms'] = array(
    'label' => t('Recent donation forms'),
    'description' => t('Configuration and submissions summary for recently created or updated springboard donation forms.'),
    'content' => '<h2>' . t('Recent donation forms ') .
      (module_exists('webform') ? l(t('Create donation form'), $base_url.'/node/add/donation-form', array('attributes' => array('class' => 'button'))) : '' ) .
      '</h2>' .
      '<div class="springboard-pane" id="springboard-recent-donation-forms">' .
      (module_exists('views') ? views_embed_view('sbv_forms', 'block_1') : t('Please enable the Views module to improve your Springboard experience.')) .
      '</div>',
    'weight' => 1,
  );
  $panes['springboard_recent_forms'] = array(
    'label' => t('Recent forms'),
    'description' => t('Configuration and submissions summary for recently created or updated springboard forms.'),
    'content' => '<h2>' . t('Recent forms ') .
      (module_exists('fundraiser') ? l(t('Create form'), $base_url.'/node/add/webform', array('attributes' => array('class' => 'button'))) : '')  .
      '</h2>' .
      '<div class="springboard-pane" id="springboard-recent-forms">' .
      (module_exists('views') ? views_embed_view('sbv_forms', 'block') : t('Please enable the Views module to improve your Springboard experience.')) .
      '</div>',
    'weight' => 2,
  );
  return $panes;
}

/**
 * Hook callback. For the Springboard Salesforce Status pane.
 */
function _springboard_sf_status() {
  $output = '';
  if (module_exists('salesforce')) {
    $identity = array();
    // Call on the module to get the current connection status
    $sf = salesforce_get_api();
    $status = FALSE;
    if ($sf->isAuthorized()) {
      $status = TRUE;
      $identity = $sf->getIdentity();
    } else {
      $status = FALSE;
    }
    // Latest batch # total items :: success :: fail.
    $batch_status = t('Batch info unavailable, please install Salesforce Log.');
    if (module_exists('salesforce_log')) {
      $query = db_select('salesforce_log_batch', 'sflog')
        ->fields('sflog')
        ->orderBy('bid', 'DESC')
        ->range(0,1)
        ->execute();
      $batch = $query->fetchObject();
      if ($batch) {
        $batch_status = t('Batch # @id - @record_count::<span class="successes">@success_count</span>::' .
          '<span class="failures">@fail_count</span>',
          array('@id' => $batch->bid, '@record_count' => $batch->count, '@success_count' => $batch->successes,
          '@fail_count' => $batch->failures));
      }
      else {
        $batch_status = t('No batches processed yet.');
      }
    }
    $queue = (module_exists('salesforce_queue') && $status) ? drupal_get_form('springboard_dashboard_queue') : '';
    return theme('springboard_sf_status', array('status' => $status, 'identity' => $identity, 'batch_status' => $batch_status, 'queue' => $queue));
  }
  return 'status';
}

/**
 * Springboard dashboard queue processor button
 */
function springboard_dashboard_queue() {
  $form = array();
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
    '#prefix' => t('Run Springboard Sync'),
    '#submit' => array('springboard_dashboard_queue_submit'),
  );
  return $form;
}

/**
 * Submit handler for Springboard dashboard queue processor button
 */
function springboard_dashboard_queue_submit(&$form_state) {
  salesforce_queue_process_queue();
}

/**
 * Helper functions.
 */

/**
 * Helper function, sort donation forms by conversion rate.
 */
function _springboard_sort_by_conversion($a, $b) {
  if (isset($a['conversion']) && isset($b['conversion'])) {
    if ($a['conversion'] == $b['conversion']) {
      return 0;
    }
    return ($a['conversion'] > $b['conversion']) ? -1 : 1;
  }
  return -1;
}

/**
 * Helper function.
 * Sets CSS class for dashboard elements based on comparison between the current value and the threshold value.
 *
 * @param $threshold
 * Int threshold value.
 *
 * @param $value
 * Int current value.
 *
 * @param $op
 * Specifies which type of comparison to perform, options are 'min' or 'max', defaults to min.
 */
function springboard_set_dashboard_class($threshold, $value, $op = 'min') {
  $value = preg_replace('/\%|ms/', '', $value);
  if (!$threshold || !is_numeric($value)) {
    $class = 'no-threshold';
  }
  else {
    switch ($op) {
      case 'min':
        $class = ($value >= $threshold) ? 'successes' : 'failures';
        break;
      case 'max':
        $class = ($value <= $threshold) ? 'successes' : 'failures';
        break;
    }
  }
  return $class;
}

/**
 * Helper function.
 * Calculate performance percentages.
 *
 * @param $a
 * Int first number.
 *
 * @param $b
 * Int second number.
 *
 * @return
 * Returns a percentage or N/A if either number is zero.
 */
function _springboard_percentage($a, $b) {
  if ($a && $b) {
    return round(100 * $a / $b) . '%';
  }
  else {
    return 'N/A';
  }
}

/**
 * Additional universal behaviors.
 */

/**
 * Implements hook_form_alter().
 */
function springboard_form_alter(&$form, &$form_state, $form_id) {
  // Alter the webform client form.
  // Why hook_form_alter and not hook_form_FORM_ID_alter?
  // Because webform's form id varies: webform_client_form_NID.
  if (strstr($form_id, 'webform_client_form') !== FALSE) {
    // Include the file with the user profile list. TODO for effeciency, move user profile list to .module
    module_include('inc', 'springboard', 'springboard.admin');
    $user_profiles = _springboard_default_user_profile();
    // For each user profile, update the field with the given value.
    foreach ($user_profile_fields as $user_profile_field) {
      $field_name = $user_profile_field['field_name'];
      $input_class = isset($user_profile_field['extra']['classes']) ? $user_profile_field['extra']['classes'] : 'input-medium';
      $field = _springboard_get_form_field($form, $field_name);
      $field['#attributes']['class'][] = $input_class;
      $form = _springboard_update_form_field($form, $field_name, $field);  
    }
  }
}

/**
 * Given a standard form array. Locate a given key and return it.
 * Recursive.
 */
function _springboard_get_form_field($form, $field_key) {
  // Walks a given form looking for the given key. Returns it when found.
  foreach (element_children($form) as $child) {
    if ($child == $field_key) {
      // Return the found array.
      return $form[$child];
    }
    else {
      // Check this child for other children.
      $found = _springboard_get_form_field($form[$child], $field_key);
      if (!empty($found)) {
        return $found;
      }
    }
  }
}

/**
 * Given a standard form array. Locate a given key and update it.
 * Recursive.
 */
function _springboard_update_form_field($form, $field_key, $new_field) {
  // Walks a given form looking for the given key. Returns it when found.
  foreach (element_children($form) as $child) {
    if ($child == $field_key) {
      // Update the array.
      $form[$child] = array_merge($form[$child], $new_field);
    }
    else {
      // Check this child for other children.
      $form[$child] = _springboard_update_form_field($form[$child], $field_key, $new_field);
    }
  }
  return $form;
}

