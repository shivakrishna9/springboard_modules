<?php

/**
* Implements hook_menu().
*/
function sb_translate_menu() {
  $items = array();
  $items['node/%node/translation-manager'] = array(
    'title' => 'Translation Manager',
    'page callback' => '_sb_translate_render_node_translation_manager',
    'page arguments' => array(arg(1)),
    'access callback' => 'sb_translate_access_check',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Determines whether the current node should display the translations tab.
 */
function sb_translate_access_check($node) {
  // TODO - Replace this with a content type level setting that saves whether translation support is enabled based on
  // LIKE THIS: $sb_translate_enabled_types = variable_get('sb_translate_content_types');
  $webform_types = variable_get('webform_node_types');
  if (in_array($node->type, $webform_types)) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Translation manager page content.
 */
function _sb_translate_render_node_translation_manager($node) {
  global $language;
  drupal_set_title(drupal_get_title() . ' - ' . 'Translation Manager' . 
    ($language->language != 'en' ? ' - ' . $language->name : '')); 

  $view = views_get_view('webform_translate_translation_manager'); // TODO - rename view to sb_translate_translation_manager
  $view->set_display('default');
  $view->pre_execute();
  $view->execute();
  $output = $view->render();
  return $output;
}

/**
 * Defines the translation manager form:
 */
function sb_translate_translation_manager_form() {
  global $language;
  $languages =  locale_language_list('name');
  unset($languages['en']); // TO DO - PROPERLY DETECT SOURCE LANGAUGE

  $view = views_get_view('webform_translate_translation_manager');
  $view->set_display('default');
  $view->pre_execute();
  $view->execute();

  $form['translation_manager'] = array(
    '#type' => 'fieldset',
    '#theme' => 'sb_translate_table_theme',
    '#translation_field_data' => array(),
  );

  $nid = arg(1);
  if (!is_numeric($nid)) {
    return array();
  }
  $node = node_load($nid);
  
  // Group source and tranlation data together for display in table rows and save label info for later:
  $view_data = array();
  foreach ($view->result as $result) {
    list($textgroup, $nid, $cid, $sub_field) = explode(':', $result->locales_source_location);
    $key = $nid . '_' . $cid . '_' . $sub_field;
    $view_data[$key]['cid'] = $cid;
    $view_data[$key]['sub_field'] = $sub_field; // Label, description, or option
    $view_data[$key]['source'] = $result->locales_source_source;
    if ($result->locales_target_language == $language->language) {
      $view_data[$key]['translations'][$result->locales_target_language] = $result->locales_target_translation;
    }
    // Handle webform components:
    if (!in_array($cid, array('amount', 'recurringamount', 'gateway')) && isset($node->webform['components'][$cid]['form_key'])) {
      // Save the node's default country to the form if states are being translated:
      if ($node->webform['components'][$cid]['form_key'] == 'state') {
        foreach ($node->webform['components'] as $translation_field_data) {
          if ($translation_field_data['form_key'] == 'country' && isset($translation_field_data['value'])) {
            $form['translation_manager']['#default_country_code'] = $translation_field_data['value'];
            break;
          }
        }
      }
      $form['translation_manager']['#translation_field_data'][$cid] = array(
        'cid' => $cid,
        'form_key' => $node->webform['components'][$cid]['form_key'],
        'textgroup' => $textgroup,
      );
    }
    // Handle Fundraiser components:
    else {
      $form['translation_manager']['#translation_field_data'][$cid] = array(
        'cid' => $cid,
        'form_key' => $cid,
        'textgroup' => $textgroup,
      );
    }
  }
  // Build the form elements:
  foreach ($view_data as $field_key => $data) {
    if (isset($node->webform['components'][$data['cid']]['form_key'])) {
      $form_key = $node->webform['components'][$data['cid']]['form_key'];
    }
    else {
      $form_key = $data['cid'];
    }

    if (isset($node->webform['components'][$data['cid']]['type'])) {    
      $type = $node->webform['components'][$data['cid']]['type'];
      if ($type == 'hidden') {
        continue;
      }
    } else {
      $type = $data['sub_field'];
    }

    // Gather the translations for this row:
    $translations = array();
    foreach ($languages as $language_code => $language_name) {
      if ($language_code != $language->language) {
        continue;
      }
      $translations[$language_code] = '';
      if (isset($data['translations'][$language_code])) {
        $translations[$language_code] = $data['translations'][$language_code];
      }
    }
     
    $form['translation_manager']['rows'][$field_key] = array(
      '#type' => 'fieldset',
    );

    if (isset($node->webform['components'][$data['cid']]['form_key'])) {
      $field_hover_info = $type . ':' . $node->webform['components'][$data['cid']]['form_key'] . ':' . $data['sub_field'];
    }
    $field_hover_data = $type . ':' . $form_key;
    $form['translation_manager']['rows'][$field_key][$field_key . '_source'] = array(
      '#type' => $data['sub_field'] == 'textarea' ? 'textarea' : 'textfield',
      '#size' => 22,
      '#default_value' => str_replace('$', '\$', $data['source']),
      '#disabled' => TRUE,
      '#attributes' => array('title' => $data['source'], 'class' => array('source-string')),
    );
    foreach ($translations as $language_code => $translation) {
      $form['translation_manager']['rows'][$field_key][$field_key . '_' . $language_code] = array(
        '#type' => $data['sub_field'] == 'textarea' ? 'textarea' : 'textfield',
        '#size' => 22,
        '#default_value' => $translation,
        '#attributes' => array('title' => isset($field_hover_info) ? $field_hover_info : $field_key),
      );      
    }
  }
  $form['translation_manager']['update_translations'] = array(
    '#type' => 'submit',
    '#value' => 'Update Translations',
  );

  $form['#attached']['css'][] =  drupal_get_path('module', 'sb_translate') . '/css/sb_translate.css';
  $form['#attached']['js'][] =  drupal_get_path('module', 'sb_translate') . '/js/sb_translate.js';
  $form['#submit'][] = '_sb_translate_update_translations';
  return $form;
}

/**
 * Form submit function for the translation manager.
 */
function _sb_translate_update_translations($form, &$form_state) {
  $nid = arg(1);
  if (!is_numeric($nid)) {
    return;
  }
  $languages =  locale_language_list('name');
  // TO DO - PROPERLY DETECT SOURCE LANGAUGE:
  unset($languages['en']);
  foreach ($form['translation_manager']['#translation_field_data'] as $cid => $translation_field_data) {
    $textgroup = $translation_field_data['textgroup'];
    foreach ($form_state['values'] as $input_key => $input_string) {
      // Handle item lists such as select options:
      if (strpos($input_key, $nid . '_' . $cid . '_') === FALSE) {
        continue;
      }

      if (strpos($input_key, $nid . '_' . $cid . '_option_') !== FALSE) {
        list($nid, $cid, $sub_field, $option_key, $language_code) = explode('_', $input_key);
        $sub_field = $sub_field . '_' . $option_key;
        $is_option = TRUE;
      }
      else {
        list($nid, $cid, $sub_field, $language_code) = explode('_', $input_key);
        $is_option = FALSE;
      }
      // Update the translation:
      if (isset($form_state['values'][$nid . '_' . $cid . '_' . $sub_field . '_' . $language_code])
        && isset($form_state['values'][$nid . '_' . $cid . '_' . $sub_field . '_source'])) {
        $translated_string = $form_state['values'][$nid . '_' . $cid . '_' . $sub_field . '_' . $language_code];
        $source_string = $form_state['values'][$nid . '_' . $cid . '_' . $sub_field . '_source'];
        $location = $nid . ':' . $cid . ':' . $sub_field;
        i18n_string_translation_update(
          $textgroup . ':' . $location,
          str_replace('$', '\$', $translated_string),
          $language_code,
          $source_string
        );
      }
    }
  }
  drupal_set_message('Translated have been updated.');
}

/**
 * Implements hook_theme().
 */
function sb_translate_theme() {
  return array(
    'sb_translate_table_theme' => array(
      'render element' => NULL, 
      'form' => NULL,
    ),
  );
}

function theme_sb_translate_table_theme($form) {
  global $language;
  $form = array_shift($form);
  $attributes = array();
  $results_language_codes = array();
 
  if (!isset($form['rows'])) {
    return;
  }

  $country_options = _sb_translate_get_enabled_countries();

  $last_row_id = '';


  $rows = array();
  foreach ($form['rows'] as $row_key => $row_data) {
    if (!is_array($row_data) || !isset($row_data['#type']) || $row_data['#type'] != 'fieldset') {
      continue;
    }
    list($nid, $id, $sub_field) = explode('_', $row_key);
    
    // If the sub-field contains delimited values only use the first value for the label:
    if (strpos($sub_field, ';') !== FALSE) {
      $sub_field = substr($sub_field, 0, strpos($sub_field, ';'));
    }

    // Add a label row before each new field:
    if ($last_row_id != $id) {
      $last_row_id = $id;
      $row_label = '';
      // Handle webform component labels:
      if (isset($form['#translation_field_data'][$id]['form_key'])) {
        $row_label = $form['#translation_field_data'][$id]['form_key'];

        // Add country filtering for the "State" field:
        if (function_exists('fundraiser_commerce_get_countries') && $form['#translation_field_data'][$id]['form_key'] == 'state') {
          $row_label .= '&nbsp;<select class="trans-manager-state-selector">' .
            '<option value="all-countries">- View All States -</option>';
          foreach ($country_options as $key => $value) {
            $selected = (isset($form['#default_country_code']) && $key == $form['#default_country_code']) ? TRUE : FALSE;
            $row_label .= '<option ' . ($selected ? 'selected="selected" ' : '') . 'value="' . $key . '">' . $value . '</option>';
          }
          $row_label .= '</select>';
        }
      }
      else {
        $row_label = 'N/A';
      }
      $row_label = str_replace('recurringamount', 'recurring amount', $row_label);
      $label_row = array('data' => array(array('data' => $row_label, 'class' => 'label-row', 'colspan' => 3)));
      $rows[] = $label_row;
    }

    // Prepare data for each row:
    $row = array();
    $row['data'][] = array('class' => 'sub-field', 'data' => $sub_field);
    foreach ($row_data as $item) {
      if (!is_array($item) || !isset($item['#type'])) {
        continue; 
      }
      if (function_exists('fundraiser_commerce_get_countries') && isset($form['#translation_field_data'][$id]['form_key'])
        && $form['#translation_field_data'][$id]['form_key'] == 'state') {
        $enabled_countries = _sb_translate_get_enabled_countries();
        foreach ($enabled_countries as $enabled_country_code => $enabled_country) { 
          if (strpos($sub_field, 'option;' . $enabled_country_code . ';') !== FALSE) {
            list($label, $country_code, $state_code) = explode(';', $sub_field);
            $item['#attributes']['country_code'] = $country_code;
            break;
          }
        }
      }
      if (isset($item['#name'])) {
        list($nid, $cid, $sub_field, $language_code) = explode('_', $item['#name']);
        if ($language_code != 'source' && !in_array($language_code, $results_language_codes)) {
          $results_language_codes[] = $language_code;
        }
      }
      $cell_class = ($language_code == 'source' ? 'source-string' : $language_code . '-string'); 
      $row['data'][] = array('class' => $cell_class, 'data' => drupal_render($item));
    }

    // Add the row:
    $rows[] = $row;
  }


  // Populate the header based on results returned:
  $languages =  locale_language_list('name');
  unset($languages['en']); // TO DO - PROPERLY DETECT SOURCE LANGAUGE:

  $header = array(t('Field'), t('Source'));
  $header[] = $language->name;

  $output = theme('table', array(
    'header' => $header,
    'rows' => $rows,
    'attributes' => array('id' => 'sb-translation-manager'),
  ));
  unset($form['rows']);
  $output .= drupal_render_children($form);
  return $output;
}

/**
 * Implements hook_views_post_render().
 */
function sb_translate_views_post_render(&$view, &$output, &$cache) {
  if ($view->name != 'webform_translate_translation_manager') {
    return;
  }
  $form = drupal_get_form('sb_translate_translation_manager_form');
  $form_html = drupal_render($form);

  // Ensure AJAX updates do not break the form:
  $arg1 = arg(1);
  $action = '/springboard/node/' . $arg1 . '/translation-manager';
  $form_html = str_replace('/views/ajax', $action, $form_html);

  // Replace default view content with the translation manager form:
  $output = preg_replace('/<div class="view-content">(.*?)<\/div>/s', $form_html, $output);

}

/**
 * Updates source translation data for this webform component, excluding hidden fields.
 *
 * @param $component
 *   The webform component being updated.
 */
function _sb_translate_webform_register_component($component) {
  if (!isset($component['cid']) || !is_numeric($component['cid'])) {
    return;
  }
  if ($component['type'] == 'hidden') {
    return;
  }

  // Ignore gateway components that are fundraiser-specific:
  if (in_array($component['form_key'], array('gateway'))) {
    return;
  }

  $textgroup = 'Webform Component';
  $location = $component['nid'] . ':' . $component['cid'];

  // Register component label:
  $source_string = $component['name'];
  i18n_string_update(
    $textgroup . ':' . $location . ':label', 
    $source_string,
    array()
  );

  // Register component description:
  if (isset($component['extra']['description'])) {
    $source_string = $component['extra']['description'];
    i18n_string_update(
      $textgroup . ':' . $location . ':description',
      $source_string,
      array()
    );
  }

  // Pull state values from the "addressfield" module if it is enabled:
  if ($component['form_key'] == 'state' && $component['type'] == 'select') {
    if (module_exists('addressfield')) {
      module_load_include('inc', 'addressfield', 'addressfield.administrative_areas');
      $countries = _sb_translate_get_enabled_countries();
      foreach ($countries as $country_code => $country) {
        $states_data = addressfield_get_administrative_areas($country_code);
        foreach ($states_data as $state_code => $state_name) {
          if ($state_name == '--') {
            continue;
          }
          i18n_string_update(
            $textgroup . ':' . $location . ':option;' . $country_code . ';' . $state_code,
            $state_name,
            array()
          );
        }
      }
      return;
    }
  }

  // Register checkbox or radio options:
  if (in_array($component['type'], array('select')) && isset($component['extra']['items'])) {
    if(in_array($component['form_key'], array('amount', 'recurring_amount'))) {
      return;
    }
    $options = explode("\n", $component['extra']['items']);
    foreach ($options as $option) {
      if (strpos($option, '|') === FALSE) {
        continue;
      }
      list($option_key, $option_value) = explode("|", $option);
      $source_string = $component['name'];
      $option_value = trim($option_value);
      i18n_string_update(
        $textgroup . ':' . $location . ':option_' . $option_key,
        $option_value,
        array()
      );
    }
  }
}

/**
 * Implements hook_webform_component_update().
 * 
 * Register a component for translation on component update:
 */
function sb_translate_webform_component_update($component) {
  _sb_translate_webform_register_component($component);
}

/**
 * Implements hook_node_presave().
 */
function sb_translate_node_presave($node) {
  $webform_types = variable_get('webform_node_types');
  if (!in_array($node->type, $webform_types) || !isset($node->webform['components'])) {
    return;
  }
  foreach ($node->webform['components'] as $cid => $component) {
    _sb_translate_webform_register_component($component);
  }
}


/**
 * Implements hook_views_query_alter().
 *
 * Filter the translation manager's results to those specific to the current webform node.
 */
function sb_translate_views_query_alter(&$view, &$query) {
  if ($view->name != 'webform_translate_translation_manager') {
    return;
  }
  $arg1 = arg(1);
  if (!is_numeric($arg1)) {
    return;
  }
  $query->where[1]['conditions'][] = array(
    'field' => 'locales_source.location',
    'value' => '%:' . $arg1 . ':%:%',
    'operator' => 'LIKE',
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Add translation manager settings to the content type settings form.
 */
function sb_translate_form_node_type_form_alter(&$form, &$form_state) {
  $sb_translate_node_type_settings = variable_get('sb_translate_node_type_settings', array());
  $form['sb_translate'] = array(
    '#type' => 'fieldset',
    '#title' => t('Translation Manager'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'additional_settings',
  );
  $form['sb_translate']['sb_translate_status'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable i18n-based translation support for') . ' ' . $form['#node_type']->name . ' ' . t(' nodes.'),
    '#default_value' => isset($sb_translate_node_type_settings[$form['#node_type']->type]['enabled']) ? 
      $sb_translate_node_type_settings[$form['#node_type']->type]['enabled'] : 0,
  );
  $form['sb_translate']['sb_translate_includes'] = array(
    '#type' => 'fieldset',
    '#title' => t('Toggle translation support'),
    '#states' => array(
      'invisible' => array(
        ':input[name="sb_translate_status"]' => array('checked' => FALSE),
      ),
    ),
  );
  // Iterate of includes directory contents to provide settings here:
  $files = file_scan_directory(drupal_get_path('module', 'sb_translate') . '/includes', '/.*?\.inc$/');
  $enabled_includes = array();
  foreach ($files as $abs => $file) {
    module_load_include('inc', 'sb_translate', 'includes/' . $file->name);
    $hook_sb_translate_include_info = $file->name . '_sb_translate_include_info';
    /*if (!function_exists($hook_sb_translate_include_info)) {
      continue;
    } */
    $include_info = $hook_sb_translate_include_info();
    if (isset($include_info['description'])) {
      $form['sb_translate']['sb_translate_includes']['sb_translate_include_' . $file->name] = array(
        '#type' => 'checkbox',
        '#title' => $include_info['description'],
        '#default_value' => isset($sb_translate_node_type_settings[$form['#node_type']->type]['data'][$file->name]) ? 1 : 0,
      );
      $enabled_includes[] = $file->name;
    }
  }
  $form['#enabled_sb_translate_includes'] = $enabled_includes;
  $form['#submit'][] = '_sb_translate_form_node_type_form_save_settings';
}

/**
 * Save content type edit form Translation Manager settings:
 */
function _sb_translate_form_node_type_form_save_settings($form, &$form_state) {
  if (!isset($form_state['build_info']['args'][0]->type)) {
    return;
  }
  $node_type = $form_state['build_info']['args'][0]->type;
  $sb_translate_node_type_settings = variable_get('sb_translate_node_type_settings', array());
  if (isset($form_state['input']['sb_translate_status']) && $form_state['input']['sb_translate_status'] == TRUE) {
    $sb_translate_node_type_settings[$node_type] = array('enabled' => TRUE);
    if (isset($form['#enabled_sb_translate_includes'])) {
      foreach ($form['#enabled_sb_translate_includes'] as $include_name) {
        if (isset($form_state['input']['sb_translate_include_' . $include_name])
          && $form_state['input']['sb_translate_include_' . $include_name] == TRUE) {
          $sb_translate_node_type_settings[$node_type]['data'][$include_name] = $include_name; 
        } else {
          unset($sb_translate_node_type_settings[$node_type]['data'][$include_name]);
        }
      }
    }
  }
  else {
    $sb_translate_node_type_settings[$node_type]['enabled'] = FALSE;
  }
  variable_set('sb_translate_node_type_settings', $sb_translate_node_type_settings);
}

/**
 * Implements hook_form_alter().
 *
 * - Adds submit function for registering non-component fundraiser strings for translation.
 * - Implements language filtering via a non-view-based exposed filter.
 * - Alters state component webform output.
 * 
 */
function sb_translate_form_alter(&$form, &$form_state, $form_id) {
  // Save non-component fundraiser fields on node edit form submission:
  if (isset($form['#node']->type) && $form_id == $form['#node']->type . '_node_form') {
    $form['#submit'][] = '_sb_translate_register_node_edit_fundraiser_strings';
    return;
  }

  // Save webform confirmation page settings:
  elseif (isset($form['#node']->type) && isset($form['#node']->nid) && $form_id == 'webform_configure_form') {
    $form['#submit'][] = '_sb_translate_register_webform_confirmation_settings';
    return;
  }

  // Translate node view webform output:
  elseif (isset($form['#node']->nid) && $form_id == 'webform_client_form_' . $form['#node']->nid) {
    $nid = $form['#node']->nid;
    // Fundraiser gateway fields:
    if (isset($form['submitted']['payment_information']['payment_method']['#options'])) {
      foreach ($form['submitted']['payment_information']['payment_method']['#options'] as $gateway_key => $gateway_label) {
        $translation = i18n_string_translate(
          'Fundraiser' . ':' . $nid . ':' . 'gateway' . ':' . 'option' . ';' . $gateway_key,
          $gateway_label,
          array()
        );
        $form['submitted']['payment_information']['payment_method']['#options'][$gateway_key] = $translation;
      }
    }
    // Payment amount labels:
    if (isset($form['submitted']['donation']['amount']['#options'])) {
      $count = 0;
      foreach ($form['submitted']['donation']['amount']['#options'] as $amount_key => $amount_label) {
        $translation = i18n_string_translate(
          'Fundraiser' . ':' . $nid . ':' . 'amount' . ':' . 'option' . ';' . ($amount_key == 'other' ? 'other' : $count),
          $amount_label,
          array()
        );
        $translation = str_replace('\$', '$', $translation);
        $form['submitted']['donation']['amount']['#options'][$amount_key] = $translation;
        $count++;
      }
    }
    // Recurring payment amount labels:
    if (isset($form['submitted']['donation']['recurring_amount']['#options'])) {
     $count = 0;
      foreach ($form['submitted']['donation']['recurring_amount']['#options'] as $amount_key => $amount_label) {
        $translation = i18n_string_translate(
          'Fundraiser' . ':' . $nid . ':' . 'recurringamount' . ':' . 'option' . ';' . ($amount_key == 'other' ? 'other' : $count),
          $amount_label,
          array()
        );
        $translation = str_replace('\$', '$', $translation);
        $form['submitted']['donation']['recurring_amount']['#options'][$amount_key] = $translation;
        $count++;
      }
    }
    // Credit payment info labels:
    if (isset($form['submitted']['payment_information']['payment_fields']['credit'])) {
      $payment_info_items = array(
        'card_number' => 'ccnumber', 
        'expiration_date' => 'expdate',
        'card_cvv' => 'cvv',
      );
      foreach ($payment_info_items as $key => $data_name) {
        if (isset($form['submitted']['payment_information']['payment_fields']['credit'][$key])) {
          $form['submitted']['payment_information']['payment_fields']['credit'][$key]['#title'] = i18n_string_translate(
            'Fundraiser' . ':' . $nid . ':' . $data_name . ':' . 'label',
            $form['submitted']['payment_information']['payment_fields']['credit'][$key]['#title'],
            array()
          );
        }
      } 
    }
    // Suffix submission message:
    $default_submit_string = 'By clicking SUBMIT your credit card will be securely processed.';
    if (isset($form['submit']['#suffix']) && strpos($form['submit']['#suffix'], $default_submit_string)) {
      $translated_submit_string = i18n_string_translate(
        'Fundraiser' . ':' . $nid . ':' . 'submitmessage' . ':' . 'label',
        $default_submit_string,
        array()
      );
      $form['submit']['#suffix'] = str_replace($default_submit_string, $translated_submit_string, $form['submit']['#suffix']);
    }
    // Form submit button: - TODO - find out where this is being updated / might need to use jQuery
    /* if (isset($form['actions']['submit']['#value'])) {
      $result = i18n_string_translate(
        'Fundraiser' . ':' . $nid . ':' . 'submitbutton' . ':' . 'label',
        $form['actions']['submit']['#value'], 
        array()
      );
    } */
    // Webform state component options based on current country:
    if (isset($form['submitted']['billing_information']['state'])) {
      $state_data = $form['submitted']['billing_information']['state'];
      if (isset($state_data['#webform_component']['cid']) 
        && isset($state_data['#webform_component']['nid'])
        && isset($form['submitted']['billing_information']['country']['#default_value'])) {
        $country_code = $form['submitted']['billing_information']['country']['#default_value'];
        $nid = $state_data['#webform_component']['nid'];
        $cid = $state_data['#webform_component']['cid'];
        foreach ($state_data['#options'] as $state_code => $state_name) {
          $form['submitted']['billing_information']['state']['#options'][$state_code] = i18n_string_translate(
            'Webform Component' . ':' . $nid . ':' . $cid . ':option;' . $country_code . ';' . $state_code,
            $state_name,
            array()
          );
        }
      }
    }
    return;
  } // End node view form translations.

  // Add the language switcher:
  elseif (isset($form_state['view']->name) && $form_state['view']->name == 'webform_translate_translation_manager'
    && $form_id == 'views_exposed_form') {
    $languages =  locale_language_list('name');
    unset($languages['en']);
    global $language;
    $switcher_js = "Drupal.behaviors.webformTranslateManagerFiltersBehavior = {
      attach: function(context) { (function($) {
        if ($('#edit-language-wrapper').length) {
          $('#edit-language-wrapper').remove();
        }
        $('.view-webform-translate-translation-manager .views-exposed-widgets .views-submit-button').before(
          '<div id=\"edit-language-wrapper\" class=\"views-widget-filter-language\">' +
            '<label for=\"edit-language\">Select language</label>' +
            '<div class=\"views-widget\">' +
            '<div class=\"form-item form-type-select form-item-language control-group\">' +
              '<select id=\"translation-manager-lang\">' +";
    foreach ($languages as $lang_code => $lang_name) {
      $is_current_lang = FALSE;
      if ($language->language == $lang_code) {
        $is_current_lang = TRUE;
      }
      $switcher_js .= "'<option value=\"" . $lang_code . "\"" . ($is_current_lang ? ' selected="selected"' : '') . ">" . $lang_name . "</option>' +";
    }
    $switcher_js .= "'</select></div></div></div>');";
    // Reload the page with a different language set for the current user on change:
    $switcher_js .= "
      $('.view-webform-translate-translation-manager #translation-manager-lang').change(function () {
        $('.view-webform-translate-translation-manager .views-reset-button,' +
          '.view-webform-translate-translation-manager .views-submit-button').hide();
        window.location = '/" . current_path() . "?language=' + $(this).val();
      });";
    $switcher_js .= "})(jQuery);}}";
    drupal_add_js($switcher_js, array('type' => 'inline', 'scope' => 'footer', 'cache' => FALSE));
    return;
  }
}

/**
 * Form submit function for the node edit form that register and updates non-component fundraiser strings for translation.
 */
function _sb_translate_register_node_edit_fundraiser_strings($form, &$form_state) {
  if (!isset($form_state['values']) || !isset($form_state['values']['nid'])) {
    return;
  }
  $textgroup = 'Fundraiser';
  $values = $form_state['values'];
  $nid = $values['nid'];

  // Donation amounts:
  if (isset($values['amount_wrapper']['donation_amounts'])) {
    foreach ($values['amount_wrapper']['donation_amounts'] as $key => $amount_data) {
      if (isset($amount_data['label'])) {
        i18n_string_update(
          $textgroup . ':' . $nid . ':' . 'amount' . ':' . 'option' . ';' . $key,
          $amount_data['label'],
          array()
        );
      }
    }
    i18n_string_update(
      $textgroup . ':' . $nid . ':' . 'amount' . ':' . 'option' . ';' . 'other',
      'Other',
      array()
    );    
  }
  // Recurring donation amounts:
  if (isset($values['recurring_amount_wrapper']['recurring_donation_amounts'])) {
    foreach ($values['recurring_amount_wrapper']['recurring_donation_amounts'] as $key => $amount_data) {
      if (isset($amount_data['label'])) {
        i18n_string_update(
          $textgroup . ':' . $nid . ':' . 'recurringamount' . ':' . 'option' . ';' . $key,
          $amount_data['label'],
          array()
        );
      }
    }
    i18n_string_update(
      $textgroup . ':' . $nid . ':' . 'recurringamount' . ':' . 'option' . ';' . 'other',
      'Other',
      array()
    );
  }
  // Payment method gateway labels:
  if (isset($values['gateways'])) {
    foreach($values['gateways'] as $gateway_key => $gateway_data) {
      if (isset($gateway_data['label'])) {
        i18n_string_update(
          $textgroup . ':' . $nid . ':' . 'gateway' . ':' . 'option' . ';' . $gateway_key,
          $gateway_data['label'],
          array()
        );
      }
    }
  }
  // Defined hardcoded, Fundraiser-related translations:
  $payment_info = array(
    'paymentmethod' => 'Payment Method',
    'ccnumber' => 'Credit card number',
    'expdate' => 'Expiration date',
    'cvv' => 'CVV',
    'submitmessage' => 'By clicking SUBMIT your credit card will be securely processed.',
    'submitbutton' => 'Submit',
  );
  foreach ($payment_info as $key => $label) {
    i18n_string_update(
      $textgroup . ':' . $nid . ':' . $key . ':' . 'label',
      $label, 
      array()
    );
  }
}

/**
 * Form submit function for registering webform confirmation page settings for translation:
 */
function _sb_translate_register_webform_confirmation_settings($form, &$form_state) {
  if (!isset($form['#node']->nid)) {
    return;
  }
  $nid = $form['#node']->nid;
  // Confirmation page title:
  if (isset($form_state['values']['confirmation']['confirmation_page_title'])) {
    i18n_string_update(
      'Webform Setting' . ':' . $nid . ':' . 'confpage' . ':' . 'title',
      $form_state['values']['confirmation']['confirmation_page_title'],
      array()
    );
  }
  // Confirmation page text:
  if (isset($form_state['values']['confirmation']['value'])) {
    $options = array();
    if (isset($form_state['values']['confirmation']['format'])) {
      $options['format'] = $form_state['values']['confirmation']['format'];
    }
    i18n_string_update( 
      'Webform Setting' . ':' . $nid . ':' . 'confpage' . ':' . 'textarea',
      $form_state['values']['confirmation']['value'],
      $options
    );
  }
}

/**
 * Implements hook_webform_component_render_alter().
 *
 * Translates webform component output.
 */
function sb_translate_webform_component_render_alter(&$element, &$component) {
  $nid = arg(1);
  if (!is_numeric($nid)) {
    return;
  }
  $textgroup = 'Webform Component';
  if (isset($element['#title'])) {
    $element['#title'] = i18n_string_translate(
      $textgroup . ':' . $nid . ':' . $component['cid'] . ':label', 
      $element['#title'],
      array()
    );
  }
  if (isset($element['#description'])) {
    $element['#description'] = i18n_string_translate(
      $textgroup . ':' . $nid . ':' . $component['cid'] . ':description',
      $element['#description'],
      array()
    );
  }
  if (in_array($element['#type'], array('checkboxes', 'radios', 'select')) && isset($element['#options'])) {
    // State options come from the "addressfield" module and are handled elsewhere:
    if ($component['form_key'] == 'state' && module_exists('addressfield')) {
      return;
    }
    foreach ($element['#options'] as $option_key => $option_value) {
      $element['#options'][$option_key] = i18n_string_translate(
        $textgroup . ':' . $nid . ':' . $component['cid'] . ':option_' . $option_key,
        $option_value,
        array()
      );
    }
  }
}

/**
 * Returns enabled countries.
 */
function _sb_translate_get_enabled_countries() {
  $countries = fundraiser_commerce_get_countries();
  $include_all_countries = variable_get('fundraiser_all_countries', 0);
  if ($include_all_countries) {
    $default_available = array();
  }
  else {
    $default_available = array('US', 'CA');
  }
  return fundraiser_commerce_get_country_options($countries->countries, $default_available);
}


